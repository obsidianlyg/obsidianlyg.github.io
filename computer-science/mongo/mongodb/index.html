<!DOCTYPE html><html lang="zh-CN"><head><meta charset="UTF-8"><meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=2"><meta name="theme-color" content="#FFF"><link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon.png"><link rel="icon" type="image/ico" sizes="32x32" href="/images/favicon.ico"><meta http-equiv="Cache-Control" content="no-transform"><meta http-equiv="Cache-Control" content="no-siteapp"><link rel="alternate" type="application/rss+xml" href="https://obsidianlyg.github.io/rss.xml"><link rel="alternate" type="application/atom+xml" href="https://obsidianlyg.github.io/atom.xml"><link rel="alternate" type="application/json" href="https://obsidianlyg.github.io/feed.json"><link rel="stylesheet" href="//fonts.googleapis.com/css?family=Mulish:300,300italic,400,400italic,700,700italic%7CFredericka%20the%20Great:300,300italic,400,400italic,700,700italic%7CNoto%20Serif%20JP:300,300italic,400,400italic,700,700italic%7CNoto%20Serif%20SC:300,300italic,400,400italic,700,700italic%7CInconsolata:300,300italic,400,400italic,700,700italic&display=swap&subset=latin,latin-ext"><link rel="stylesheet" href="/css/app.css?v=0.2.5"><link rel="canonical" href="https://obsidianlyg.github.io/computer-science/mongo/mongodb/"><title>MongoDB - MongoDB - 计算机科学 | Obsidianlyg's Blog = = 最好的生活是：时光，浓淡相宜，人心，远近相安</title><meta name="generator" content="Hexo 5.4.2"></head><body itemscope itemtype="http://schema.org/WebPage"><div id="loading"><div class="cat"><div class="body"></div><div class="head"><div class="face"></div></div><div class="foot"><div class="tummy-end"></div><div class="bottom"></div><div class="legs left"></div><div class="legs right"></div></div><div class="paw"><div class="hands left"></div><div class="hands right"></div></div></div></div><div id="container"><header id="header" itemscope itemtype="http://schema.org/WPHeader"><div class="inner"><div id="brand"><div class="pjax"><h1 itemprop="name headline">MongoDB</h1><div class="meta"><span class="item" title="创建时间：2021-12-24 00:00:00"><span class="icon"><i class="ic i-calendar"></i> </span><span class="text">发表于</span> <time itemprop="dateCreated datePublished" datetime="2021-12-24T00:00:00+08:00">2021-12-24</time> </span><span class="item" title="本文字数"><span class="icon"><i class="ic i-pen"></i> </span><span class="text">本文字数</span> <span>20k</span> <span class="text">字</span> </span><span class="item" title="阅读时长"><span class="icon"><i class="ic i-clock"></i> </span><span class="text">阅读时长</span> <span>19 分钟</span></span></div></div></div><nav id="nav"><div class="inner"><div class="toggle"><div class="lines" aria-label="切换导航栏"><span class="line"></span> <span class="line"></span> <span class="line"></span></div></div><ul class="menu"><li class="item title"><a href="/" rel="start">Obsidianlyg's Blog</a></li></ul><ul class="right"><li class="item theme"><i class="ic i-sun"></i></li><li class="item search"><i class="ic i-search"></i></li></ul></div></nav></div><div id="imgs" class="pjax"><img src="/assets/wallpaper-2572384.jpg"></div></header><div id="waves"><svg class="waves" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" viewBox="0 24 150 28" preserveAspectRatio="none" shape-rendering="auto"><defs><path id="gentle-wave" d="M-160 44c30 0 58-18 88-18s 58 18 88 18 58-18 88-18 58 18 88 18 v44h-352z"/></defs><g class="parallax"><use xlink:href="#gentle-wave" x="48" y="0"/><use xlink:href="#gentle-wave" x="48" y="3"/><use xlink:href="#gentle-wave" x="48" y="5"/><use xlink:href="#gentle-wave" x="48" y="7"/></g></svg></div><main><div class="inner"><div id="main" class="pjax"><div class="article wrap"><div class="breadcrumb" itemscope itemtype="https://schema.org/BreadcrumbList"><i class="ic i-home"></i> <span><a href="/">首页</a></span><i class="ic i-angle-right"></i> <span itemprop="itemListElement" itemscope itemtype="https://schema.org/ListItem"><a href="/categories/computer-science/" itemprop="item" rel="index" title="分类于 计算机科学"><span itemprop="name">计算机科学</span></a><meta itemprop="position" content="1"></span><i class="ic i-angle-right"></i> <span class="current" itemprop="itemListElement" itemscope itemtype="https://schema.org/ListItem"><a href="/categories/computer-science/mongo/" itemprop="item" rel="index" title="分类于 MongoDB"><span itemprop="name">MongoDB</span></a><meta itemprop="position" content="2"></span></div><article itemscope itemtype="http://schema.org/Article" class="post block" lang="zh-CN"><link itemprop="mainEntityOfPage" href="https://obsidianlyg.github.io/computer-science/mongo/mongodb/"><span hidden itemprop="author" itemscope itemtype="http://schema.org/Person"><meta itemprop="image" content="/images/avatar.jpg"><meta itemprop="name" content="obsidianlyg"><meta itemprop="description" content="最好的生活是：时光，浓淡相宜，人心，远近相安, 最好的生活是：时光，浓淡相宜，人心，远近相安"></span><span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization"><meta itemprop="name" content=""></span><div class="body md" itemprop="articleBody"><h1 id="mongodb"><a class="anchor" href="#mongodb">#</a> MongoDB</h1><ul><li><h2 id="将mongodb加入到windows服务中"><a class="anchor" href="#将mongodb加入到windows服务中">#</a> <strong>将 MongoDB 加入到 Windows 服务中</strong></h2><ul><li><p><strong>创建服务:</strong></p><figure class="highlight bash"><figcaption data-lang="bash"></figcaption><table><tr><td data-num="1"></td><td><pre>mongod --dbpath <span class="token string">"D:\MongoDbData"</span> --logpath <span class="token string">"D:\MongoDbData\log\MongoDB.log"</span> --install --serviceName <span class="token string">"MongoDB"</span></pre></td></tr></table></figure></li><li><p><strong>启动 MongoDB：</strong></p><figure class="highlight bash"><figcaption data-lang="bash"></figcaption><table><tr><td data-num="1"></td><td><pre>net start MongoDB</pre></td></tr></table></figure></li><li><p><strong>删除服务：</strong></p><figure class="highlight bash"><figcaption data-lang="bash"></figcaption><table><tr><td data-num="1"></td><td><pre>mongod --dbpath <span class="token string">"D:\MongoDbData"</span> --logpath <span class="token string">"D:\MongoDbData\log\MongoDB.log"</span> --install --remove <span class="token string">"MongoDB"</span></pre></td></tr></table></figure></li><li><p><strong>停止服务：</strong></p><figure class="highlight bash"><figcaption data-lang="bash"></figcaption><table><tr><td data-num="1"></td><td><pre>net stop MongoDB</pre></td></tr></table></figure></li></ul></li><li><h2 id="导出集合"><a class="anchor" href="#导出集合">#</a> <strong>导出集合</strong></h2><p>mongoexport.exe -d db_name -c collection_name -o d:\data\test.json</p><p><span class="exturl" data-url="aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L0cxQXBhc3N6L2FydGljbGUvZGV0YWlscy80MzgzNzMzMQ==">https://blog.csdn.net/G1Apassz/article/details/43837331</span></p></li><li><h2 id="导入文件"><a class="anchor" href="#导入文件">#</a> <strong>导入文件</strong></h2><figure class="highlight bash"><figcaption data-lang="bash"></figcaption><table><tr><td data-num="1"></td><td><pre>mongoimport -d dbs -c col --file path</pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token comment">#导入 csv 文件</span></pre></td></tr><tr><td data-num="3"></td><td><pre>mongoimport -d Testdb1 -c score --type csv --headerline --ignoreBlanks --file test.csv</pre></td></tr></table></figure></li><li><h2 id="数据库操作"><a class="anchor" href="#数据库操作">#</a> <strong>数据库操作</strong></h2><p>查看版本： <code>db.version();</code></p><p>创建数据库: <code>use DATABASE_NAME</code></p><p>查看当前数据库: <code>db</code></p><p>查看数据库 (空库不在列表内）: <code>show dbs</code></p><p>删库: <code>db.dropDatabase()</code></p></li><li><h2 id="集合操作"><a class="anchor" href="#集合操作">#</a> <strong>集合操作</strong></h2><p>创建集合: <code>db.createCollection(name, options(可选项))</code></p><p>删除集合: <code>db.collection.drop()</code></p><p>查看集合: <code>show collections</code> 或者 <code>show tables</code></p><p>删除全部数据（集合并不会删除）: <code>db.col.remove(&#123;&#125;)</code></p><p>save 与 insert 区别：save 可以替换已有的文档，insert 不能。</p></li><li><h2 id="基本知识点学习通测试题"><a class="anchor" href="#基本知识点学习通测试题">#</a> <strong>基本知识点（学习通测试题）</strong></h2><p>MongoDB 数据文件的存储格式为：BSON</p><p>MongoDB 适合网站数据，SQL，缓存</p><p><strong>mongodb 的存储引擎：WiredTiger，MMAPv1 和 In-Memory。</strong></p><p>NoSQL 全称：NotOnlySQL</p><p>默认端口：27017</p><p>NoSQL 特点：（没有一个明确的范围和定义，以下是 mongodb 书上的）</p><ol><li>可弹性扩展</li><li>大数据量，高性能</li><li>Base 特征</li><li>灵活的数据模型</li><li>高可用</li></ol><p>属于 NoSQL 的数据库种类：<strong>HBase、Redis、MongoDB、Couchbase、LevelDB</strong></p><p>在 MongoDB 的集合中相当于关系的 key 是 ObjectId；</p><p>使用 CreateCollection 创建固定集合时必须添加参数：capped</p><p>数据库备份命令:mongodump</p><p>gridfs 定义及原理</p><p>是 MongoDB 中存储和查询超过 BSON 文件大小限制（16M）的规范</p><p>GridFS 将文件分成多个块，每个块作为一个单独的文档</p><p>在 MongoDB 的固定集合中如果被占满，再插入新文档时，固定集合会自动将最老的文档从集合中删除。</p><p>对目标集使用 insert 方法，插入一个文档，这个操作<strong>不一定</strong>会给文档增加一个 &quot;_id&quot; 键，让后将其保存到 MongoDB 中。</p><p>空的查询文档 {} 会匹配集合的全部内容。要是不指定查询文档，默认就是 {}。</p><p>update 修改字段名称用 $rename；</p><p>MongoDB 服务器可以利用复制集部署多个集群，好处是：复制时将数据自动同步到多个服务器中。</p><p>MongoDB 中副本集的方式可以利用仲裁机制将从节点推举成新的主节点。</p><p>MapReduce 中 map 函数是映射，reduce 函数是归并</p><p>为了维护集合的最新视图，每个成员每隔两秒钟就会系那个其他成员发送一个请求，这个请求是心跳请求。</p><p>MongoDB 中部署一个分片集群需要三部分，包括 Shard Server, Config Server 和 Route Server。</p><p>如果在创建唯一索引时已经存在了重复项，可以通过 dropDups 参数消除重复文档。</p><p>MongoDB 不仅支持自动故障恢复，还支持自动分片</p><p>聚合数据模型是 MapReduce；</p></li><li><p><strong>remove 与 drop 区别</strong></p><p>remove：删除所有文档，但是保留索引（index）文件</p><p>db.system.indexs.find () 查询索引依然存在</p><p>drop：真 * 删除所有文档</p></li><li><h2 id="find系列"><a class="anchor" href="#find系列">#</a> <strong>find 系列</strong></h2><p>结构化查询</p><figure class="highlight bash"><figcaption data-lang="bash"></figcaption><table><tr><td data-num="1"></td><td><pre>db.col.find<span class="token punctuation">(</span><span class="token punctuation">)</span>.pretty<span class="token punctuation">(</span><span class="token punctuation">)</span></pre></td></tr></table></figure><p>查询在 1997 年 1 月 1 日之后出生的人</p><figure class="highlight bash"><figcaption data-lang="bash"></figcaption><table><tr><td data-num="1"></td><td><pre>db.col.find<span class="token punctuation">(</span><span class="token punctuation">&#123;</span><span class="token string">"date"</span>:<span class="token punctuation">&#123;</span><span class="token variable">$gte</span>:new Date<span class="token punctuation">(</span><span class="token number">1997,1</span>,1<span class="token punctuation">)</span><span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span><span class="token punctuation">)</span></pre></td></tr></table></figure><p>大小关系</p><figure class="highlight bash"><figcaption data-lang="bash"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token punctuation">(</span><span class="token operator">></span><span class="token punctuation">)</span> 大于 - <span class="token variable">$gt</span></pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token punctuation">(</span><span class="token operator">&lt;</span><span class="token punctuation">)</span> 小于 - <span class="token variable">$lt</span></pre></td></tr><tr><td data-num="3"></td><td><pre><span class="token punctuation">(</span><span class="token operator">>=</span><span class="token punctuation">)</span> 大于等于 - <span class="token variable">$gte</span></pre></td></tr><tr><td data-num="4"></td><td><pre><span class="token punctuation">(</span><span class="token operator">&lt;=</span> <span class="token punctuation">)</span> 小于等于 - <span class="token variable">$lte</span></pre></td></tr><tr><td data-num="5"></td><td><pre><span class="token punctuation">(</span><span class="token operator">!=</span><span class="token punctuation">)</span> 不等于 - <span class="token variable">$ne</span></pre></td></tr></table></figure><p>相关语法 ( <code>$not</code> 也是这个语法推荐 <code>$ne</code> )</p><figure class="highlight bash"><figcaption data-lang="bash"></figcaption><table><tr><td data-num="1"></td><td><pre>db.col.find<span class="token punctuation">(</span><span class="token punctuation">&#123;</span>age:<span class="token punctuation">&#123;</span><span class="token variable">$gte</span>:25, <span class="token variable">$lte</span>:27<span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span><span class="token punctuation">)</span></pre></td></tr></table></figure><p>语法默认是 and，</p><p><code>$or</code> 或者 <code>$​nor</code> 用法</p><figure class="highlight bash"><figcaption data-lang="bash"></figcaption><table><tr><td data-num="1"></td><td><pre>db.col.find<span class="token punctuation">(</span><span class="token punctuation">&#123;</span><span class="token variable">$or</span>:<span class="token punctuation">[</span><span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span>,<span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span><span class="token punctuation">]</span><span class="token punctuation">&#125;</span><span class="token punctuation">)</span></pre></td></tr></table></figure><p><code>$in</code> 或 <code>$​nin</code> (对 in 来说只要里面有一个符合，就列出来)</p><figure class="highlight bash"><figcaption data-lang="bash"></figcaption><table><tr><td data-num="1"></td><td><pre>db.col.find<span class="token punctuation">(</span><span class="token punctuation">&#123;</span>age:<span class="token punctuation">&#123;</span><span class="token variable">$in</span>:<span class="token punctuation">[</span><span class="token number">12</span>, <span class="token number">13</span><span class="token punctuation">]</span><span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="2"></td><td><pre>db.employee.find<span class="token punctuation">(</span> <span class="token punctuation">&#123;</span> interest: <span class="token punctuation">&#123;</span><span class="token variable">$in</span> <span class="token builtin class-name">:</span> <span class="token punctuation">[</span> ‘看电影’ , ‘画画’<span class="token punctuation">]</span><span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span><span class="token punctuation">)</span></pre></td></tr></table></figure><p>自定义显示属性列 (0: 不显示，1: 显示，id 默认显示)</p><figure class="highlight bash"><figcaption data-lang="bash"></figcaption><table><tr><td data-num="1"></td><td><pre>db.col.find<span class="token punctuation">(</span><span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span>, <span class="token punctuation">&#123;</span>date:1<span class="token punctuation">&#125;</span><span class="token punctuation">)</span></pre></td></tr></table></figure><p><code>$mod</code></p><figure class="highlight bash"><figcaption data-lang="bash"></figcaption><table><tr><td data-num="1"></td><td><pre>find<span class="token punctuation">(</span><span class="token string">"<span class="token variable">$mod</span>"</span>:<span class="token punctuation">[</span>数字，余数<span class="token punctuation">]</span><span class="token punctuation">)</span></pre></td></tr></table></figure><p><code>$exists</code> 判断字段是否存在 (true/false)</p><figure class="highlight python"><figcaption data-lang="python"></figcaption><table><tr><td data-num="1"></td><td><pre>db<span class="token punctuation">.</span>users<span class="token punctuation">.</span>find<span class="token punctuation">(</span><span class="token punctuation">&#123;</span>age<span class="token punctuation">:</span> <span class="token punctuation">&#123;</span>$exists<span class="token punctuation">:</span> true<span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr></table></figure><p>limit</p><figure class="highlight bash"><figcaption data-lang="bash"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token comment"># 只显示前 5 条数据</span></pre></td></tr><tr><td data-num="2"></td><td><pre>find<span class="token punctuation">(</span><span class="token punctuation">)</span>.limit<span class="token punctuation">(</span><span class="token number">5</span><span class="token punctuation">)</span></pre></td></tr></table></figure><p>skip 查第 6-10 条数据</p><figure class="highlight bash"><figcaption data-lang="bash"></figcaption><table><tr><td data-num="1"></td><td><pre>find<span class="token punctuation">(</span><span class="token punctuation">)</span>.limit<span class="token punctuation">(</span><span class="token number">5</span><span class="token punctuation">)</span>.skip<span class="token punctuation">(</span><span class="token number">5</span><span class="token punctuation">)</span> <span class="token comment">#跳过 5 条数据，从第六条开始</span></pre></td></tr></table></figure><p>sort () : [1 (升序), -1 (降序)]</p><figure class="highlight bash"><figcaption data-lang="bash"></figcaption><table><tr><td data-num="1"></td><td><pre>find<span class="token punctuation">(</span><span class="token punctuation">)</span>.sort<span class="token punctuation">(</span><span class="token punctuation">&#123;</span>age:1<span class="token punctuation">&#125;</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="2"></td><td><pre>或者直接sort<span class="token punctuation">(</span><span class="token punctuation">&#123;</span>age:1<span class="token punctuation">&#125;</span><span class="token punctuation">)</span>（老师说的，实际上并不行）</pre></td></tr></table></figure><p>count()</p><figure class="highlight bash"><figcaption data-lang="bash"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token number">1</span>. 推荐</pre></td></tr><tr><td data-num="2"></td><td><pre>db.col.count<span class="token punctuation">(</span>查询条件<span class="token punctuation">)</span></pre></td></tr><tr><td data-num="3"></td><td><pre><span class="token number">2</span>. 其他方式<span class="token punctuation">(</span>别在count内写，没用<span class="token punctuation">)</span></pre></td></tr><tr><td data-num="4"></td><td><pre>db.col.find<span class="token punctuation">(</span>查询条件<span class="token punctuation">)</span>.count<span class="token punctuation">(</span><span class="token punctuation">)</span></pre></td></tr></table></figure><ul><li><p>针对数据处理的字段</p><p><code>$all</code> (来匹配包含数组所有元素的文档，元素顺序不影响结果)</p><figure class="highlight bash"><figcaption data-lang="bash"></figcaption><table><tr><td data-num="1"></td><td><pre>db.employee.find<span class="token punctuation">(</span> <span class="token punctuation">&#123;</span> interest: <span class="token punctuation">&#123;</span><span class="token variable">$all</span> <span class="token builtin class-name">:</span> <span class="token punctuation">[</span> ‘看电影’ , ‘画画’<span class="token punctuation">]</span><span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span><span class="token punctuation">)</span></pre></td></tr></table></figure><p><code>$size</code> (查询指定长度的数组)</p><figure class="highlight bash"><figcaption data-lang="bash"></figcaption><table><tr><td data-num="1"></td><td><pre>查询有五种爱好的人</pre></td></tr><tr><td data-num="2"></td><td><pre>db.employee.find<span class="token punctuation">(</span> <span class="token punctuation">&#123;</span>interest <span class="token builtin class-name">:</span> <span class="token punctuation">&#123;</span><span class="token variable">$size</span> <span class="token builtin class-name">:</span> <span class="token number">5</span><span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span><span class="token punctuation">)</span></pre></td></tr></table></figure><p><code>$slice</code> (用于指定查询结果中要显示的数组元素，<strong>放在 find 的第二个参数中</strong>)</p><figure class="highlight bash"><figcaption data-lang="bash"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token number">1</span>.</pre></td></tr><tr><td data-num="2"></td><td><pre>find<span class="token punctuation">(</span> <span class="token punctuation">&#123;</span>查询条件<span class="token punctuation">&#125;</span> ，<span class="token punctuation">&#123;</span>field <span class="token builtin class-name">:</span> <span class="token punctuation">&#123;</span><span class="token variable">$slice</span> <span class="token builtin class-name">:</span> value<span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="3"></td><td><pre>value取值：整数n, 正数显示数组前n个元素，负数显示数组后n个元素</pre></td></tr><tr><td data-num="4"></td><td><pre><span class="token number">2</span>.</pre></td></tr><tr><td data-num="5"></td><td><pre>db.num.find<span class="token punctuation">(</span><span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span>, <span class="token punctuation">&#123;</span>num:<span class="token punctuation">&#123;</span><span class="token variable">$slice</span>:<span class="token punctuation">[</span><span class="token number">0</span>, <span class="token number">3</span><span class="token punctuation">]</span><span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span><span class="token punctuation">)</span>   <span class="token comment">#正数从第 n+1 个元素，负数从倒数第 n 个开始，往后显示 count 个元素</span></pre></td></tr><tr><td data-num="6"></td><td><pre><span class="token number">3</span>.</pre></td></tr><tr><td data-num="7"></td><td><pre><span class="token variable">$slice</span>:0      <span class="token comment">#不显示数组内容</span></pre></td></tr></table></figure><p><code>$elemMatch</code> （查子文档）</p><figure class="highlight bash"><figcaption data-lang="bash"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token number">1</span>.</pre></td></tr><tr><td data-num="2"></td><td><pre>db.neiqian.find<span class="token punctuation">(</span><span class="token punctuation">&#123;</span>parents:<span class="token punctuation">&#123;</span><span class="token variable">$elemMatch</span>:<span class="token punctuation">&#123;</span>job:<span class="token string">"a"</span><span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="3"></td><td><pre><span class="token number">2</span>.</pre></td></tr><tr><td data-num="4"></td><td><pre>db.neiqian.find<span class="token punctuation">(</span><span class="token punctuation">&#123;</span><span class="token string">"parents.job"</span><span class="token builtin class-name">:</span><span class="token string">"a"</span><span class="token punctuation">&#125;</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="5"></td><td><pre><span class="token number">3</span>.与逻辑运算符同用</pre></td></tr><tr><td data-num="6"></td><td><pre>db.neiqian.find<span class="token punctuation">(</span><span class="token punctuation">&#123;</span><span class="token variable">$or</span>:<span class="token punctuation">[</span><span class="token punctuation">&#123;</span><span class="token string">"parents.job"</span><span class="token builtin class-name">:</span><span class="token string">"a"</span><span class="token punctuation">&#125;</span>,<span class="token punctuation">&#123;</span><span class="token string">"parents.job"</span><span class="token builtin class-name">:</span><span class="token string">"b"</span><span class="token punctuation">&#125;</span><span class="token punctuation">]</span><span class="token punctuation">&#125;</span><span class="token punctuation">)</span></pre></td></tr></table></figure><p>查询数组内部数据个数大于等于 4 的</p><figure class="highlight bash"><figcaption data-lang="bash"></figcaption><table><tr><td data-num="1"></td><td><pre>db.num.find<span class="token punctuation">(</span><span class="token punctuation">&#123;</span><span class="token variable">$where</span><span class="token builtin class-name">:</span><span class="token string">"this.num.length>=4"</span><span class="token punctuation">&#125;</span><span class="token punctuation">)</span></pre></td></tr></table></figure></li><li><p>统计所有人的指定数组的元素个数</p><figure class="highlight bash"><figcaption data-lang="bash"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token operator">></span> db.mycollection.insert<span class="token punctuation">(</span><span class="token punctuation">&#123;</span><span class="token string">'foo'</span>:<span class="token punctuation">[</span><span class="token number">1,2</span>,3,4<span class="token punctuation">]</span><span class="token punctuation">&#125;</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="2"></td><td><pre></pre></td></tr><tr><td data-num="3"></td><td><pre><span class="token operator">></span> db.mycollection.insert<span class="token punctuation">(</span><span class="token punctuation">&#123;</span><span class="token string">'foo'</span>:<span class="token punctuation">[</span><span class="token number">5,6</span>,7<span class="token punctuation">]</span><span class="token punctuation">&#125;</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="4"></td><td><pre></pre></td></tr><tr><td data-num="5"></td><td><pre><span class="token operator">></span> db.mycollection.aggregate<span class="token punctuation">(</span><span class="token punctuation">&#123;</span><span class="token variable">$project</span><span class="token builtin class-name">:</span> <span class="token punctuation">&#123;</span> count: <span class="token punctuation">&#123;</span> <span class="token variable">$size</span><span class="token builtin class-name">:</span><span class="token string">"<span class="token variable">$foo</span>"</span> <span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="6"></td><td><pre></pre></td></tr><tr><td data-num="7"></td><td><pre><span class="token punctuation">&#123;</span> <span class="token string">"_id"</span> <span class="token builtin class-name">:</span> ObjectId<span class="token punctuation">(</span><span class="token string">"5314b5c360477752b449eedf"</span><span class="token punctuation">)</span>, <span class="token string">"count"</span> <span class="token builtin class-name">:</span> <span class="token number">4</span> <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="8"></td><td><pre></pre></td></tr><tr><td data-num="9"></td><td><pre><span class="token punctuation">&#123;</span> <span class="token string">"_id"</span> <span class="token builtin class-name">:</span> ObjectId<span class="token punctuation">(</span><span class="token string">"5314b5c860477752b449eee0"</span><span class="token punctuation">)</span>, <span class="token string">"count"</span> <span class="token builtin class-name">:</span> <span class="token number">3</span> <span class="token punctuation">&#125;</span></pre></td></tr></table></figure></li><li><p>正则的相关用法</p><figure class="highlight bash"><figcaption data-lang="bash"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token comment"># 查询以 a 字符开头的元素</span></pre></td></tr><tr><td data-num="2"></td><td><pre>db.num.find<span class="token punctuation">(</span><span class="token punctuation">&#123;</span>name:/^a/<span class="token punctuation">&#125;</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="3"></td><td><pre><span class="token comment"># 查询以 b 字符结尾的元素</span></pre></td></tr><tr><td data-num="4"></td><td><pre>db.num.find<span class="token punctuation">(</span><span class="token punctuation">&#123;</span>name:/b$/<span class="token punctuation">&#125;</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="5"></td><td><pre><span class="token comment"># 同时具有上方两个条件查询（注；必须以结尾语法查询开始，具体如下）</span></pre></td></tr><tr><td data-num="6"></td><td><pre>db.num.find<span class="token punctuation">(</span><span class="token punctuation">&#123;</span>name:/b$/,name:/^a/<span class="token punctuation">&#125;</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="7"></td><td><pre><span class="token comment"># 如果知道中间相差的具体有几个字符数可以用 "." 充当中间的字符数，例如：</span></pre></td></tr><tr><td data-num="8"></td><td><pre>db.num.find<span class="token punctuation">(</span><span class="token punctuation">&#123;</span>name:/^a<span class="token punctuation">..</span>b$/<span class="token punctuation">&#125;</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="9"></td><td><pre><span class="token punctuation">&#123;</span> <span class="token string">"_id"</span> <span class="token builtin class-name">:</span> ObjectId<span class="token punctuation">(</span><span class="token string">"61695d44b1d6dee2a6ab7c31"</span><span class="token punctuation">)</span>, <span class="token string">"name"</span> <span class="token builtin class-name">:</span> <span class="token string">"assb"</span> <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="10"></td><td><pre><span class="token comment"># 模糊查询（包含伟字就行）</span></pre></td></tr><tr><td data-num="11"></td><td><pre>db.student.find<span class="token punctuation">(</span><span class="token punctuation">&#123;</span>sname:/^.*伟.*$/<span class="token punctuation">&#125;</span>,<span class="token punctuation">&#123;</span>_id:0, sname:1<span class="token punctuation">&#125;</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="12"></td><td><pre><span class="token comment"># 注：另一种语法格式，如下：</span></pre></td></tr><tr><td data-num="13"></td><td><pre>db.posts.find<span class="token punctuation">(</span><span class="token punctuation">&#123;</span>tags:<span class="token punctuation">&#123;</span><span class="token variable">$regex</span><span class="token builtin class-name">:</span><span class="token string">"run"</span><span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span><span class="token punctuation">)</span></pre></td></tr></table></figure><figure class="highlight bash"><figcaption data-lang="bash"></figcaption><table><tr><td data-num="1"></td><td><pre>模糊查询中正则表达式中/i,/g,/ig,/gi,/m的区别和含义</pre></td></tr><tr><td data-num="2"></td><td><pre></pre></td></tr><tr><td data-num="3"></td><td><pre>/i <span class="token punctuation">(</span>忽略大小写<span class="token punctuation">)</span></pre></td></tr><tr><td data-num="4"></td><td><pre>/g <span class="token punctuation">(</span>全文查找出现的所有匹配字符<span class="token punctuation">)</span></pre></td></tr><tr><td data-num="5"></td><td><pre>/m <span class="token punctuation">(</span>多行查找<span class="token punctuation">)</span></pre></td></tr><tr><td data-num="6"></td><td><pre>/gi<span class="token punctuation">(</span>全文查找、忽略大小写<span class="token punctuation">)</span></pre></td></tr><tr><td data-num="7"></td><td><pre>/ig<span class="token punctuation">(</span>全文查找、忽略大小写<span class="token punctuation">)</span></pre></td></tr></table></figure></li></ul></li><li><h2 id="update系列"><a class="anchor" href="#update系列">#</a> <strong>update 系列</strong></h2><figure class="highlight bash"><figcaption data-lang="bash"></figcaption><table><tr><td data-num="1"></td><td><pre>update<span class="token punctuation">(</span>query, update, upsert, multi, writeConcern<span class="token punctuation">)</span></pre></td></tr><tr><td data-num="2"></td><td><pre>query <span class="token builtin class-name">:</span> update的查询条件，类似sql update查询内where后面的。</pre></td></tr><tr><td data-num="3"></td><td><pre>update <span class="token builtin class-name">:</span> update的对象和一些更新的操作符（如$,<span class="token variable">$inc</span><span class="token punctuation">..</span>.）等，也可以理解为sql update查询内set后面的</pre></td></tr><tr><td data-num="4"></td><td><pre>upsert <span class="token builtin class-name">:</span> 可选，这个参数的意思是，如果不存在update的记录，是否插入objNew,true为插入，默认是false，不插入。</pre></td></tr><tr><td data-num="5"></td><td><pre>multi <span class="token builtin class-name">:</span> 可选，mongodb 默认是false,只更新找到的第一条记录，如果这个参数为true,就把按条件查出来多条记录全部更新。</pre></td></tr><tr><td data-num="6"></td><td><pre>writeConcern :可选，抛出异常的级别。</pre></td></tr></table></figure><p><code>$set</code> 只更新字段 (有则修改，无则追加）</p><figure class="highlight bash"><figcaption data-lang="bash"></figcaption><table><tr><td data-num="1"></td><td><pre>db.person2.update<span class="token punctuation">(</span><span class="token punctuation">&#123;</span>birthday:<span class="token string">"1996-02-14"</span><span class="token punctuation">&#125;</span>,<span class="token punctuation">&#123;</span><span class="token variable">$set</span>:<span class="token punctuation">&#123;</span>birthday:<span class="token string">"1996"</span><span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span><span class="token punctuation">)</span></pre></td></tr></table></figure><p><code>$inc</code> 针对数值型的键进行加减运算</p><figure class="highlight bash"><figcaption data-lang="bash"></figcaption><table><tr><td data-num="1"></td><td><pre>db.mdb.update<span class="token punctuation">(</span><span class="token punctuation">&#123;</span>name:<span class="token string">"张三"</span><span class="token punctuation">&#125;</span>,<span class="token punctuation">&#123;</span><span class="token variable">$inc</span>:<span class="token punctuation">&#123;</span>age:-2<span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span><span class="token punctuation">)</span></pre></td></tr></table></figure><p><code>$unset</code> 删除指定 key</p><figure class="highlight bash"><figcaption data-lang="bash"></figcaption><table><tr><td data-num="1"></td><td><pre>db.mdb.update<span class="token punctuation">(</span><span class="token punctuation">&#123;</span>name:<span class="token string">"张三"</span><span class="token punctuation">&#125;</span>,<span class="token punctuation">&#123;</span><span class="token variable">$unset</span>:<span class="token punctuation">&#123;</span>age:1<span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span><span class="token punctuation">)</span></pre></td></tr></table></figure><ul><li><p>针对数组</p><p><code>$push</code> 无条件追加</p><figure class="highlight bash"><figcaption data-lang="bash"></figcaption><table><tr><td data-num="1"></td><td><pre>db.mdb.update<span class="token punctuation">(</span><span class="token punctuation">&#123;</span>name:<span class="token string">"张三"</span><span class="token punctuation">&#125;</span>,<span class="token punctuation">&#123;</span><span class="token variable">$push</span>:<span class="token punctuation">&#123;</span>course:<span class="token string">"sdsd"</span><span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span><span class="token punctuation">)</span></pre></td></tr></table></figure><p><code>$pushAll</code> 追加多个</p><figure class="highlight bash"><figcaption data-lang="bash"></figcaption><table><tr><td data-num="1"></td><td><pre>db.mdb.update<span class="token punctuation">(</span><span class="token punctuation">&#123;</span>name:<span class="token string">"张三"</span><span class="token punctuation">&#125;</span>,<span class="token punctuation">&#123;</span><span class="token variable">$pushAll</span>:<span class="token punctuation">&#123;</span>course:<span class="token punctuation">[</span><span class="token string">"wen"</span>,<span class="token string">"quan"</span><span class="token punctuation">]</span><span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span><span class="token punctuation">)</span></pre></td></tr></table></figure><p><code>$addToSet</code> 若是存在则不插入</p><figure class="highlight bash"><figcaption data-lang="bash"></figcaption><table><tr><td data-num="1"></td><td><pre>db.mdb.update<span class="token punctuation">(</span><span class="token punctuation">&#123;</span>name:<span class="token string">"张三"</span><span class="token punctuation">&#125;</span>,<span class="token punctuation">&#123;</span><span class="token variable">$addToSet</span>:<span class="token punctuation">&#123;</span>course:<span class="token string">"sds"</span><span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span><span class="token punctuation">)</span></pre></td></tr></table></figure><p><code>$pop</code> n 为删除最后 n 个，-n 为删除正数 n 个</p><figure class="highlight bash"><figcaption data-lang="bash"></figcaption><table><tr><td data-num="1"></td><td><pre>db.mdb.update<span class="token punctuation">(</span><span class="token punctuation">&#123;</span>name:<span class="token string">"张三"</span><span class="token punctuation">&#125;</span>,<span class="token punctuation">&#123;</span><span class="token variable">$pop</span>:<span class="token punctuation">&#123;</span>course:1<span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span><span class="token punctuation">)</span></pre></td></tr></table></figure><p><code>$pull</code> 删除指定字段 <code>$pullAll</code> 与 <code>$pushAll</code> 同理</p><figure class="highlight bash"><figcaption data-lang="bash"></figcaption><table><tr><td data-num="1"></td><td><pre>db.mdb.update<span class="token punctuation">(</span><span class="token punctuation">&#123;</span>name:<span class="token string">"张三"</span><span class="token punctuation">&#125;</span>,<span class="token punctuation">&#123;</span><span class="token variable">$pull</span>:<span class="token punctuation">&#123;</span>course:<span class="token string">"sdsd"</span><span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span><span class="token punctuation">)</span></pre></td></tr></table></figure></li></ul><p><code>$rename</code> 对字段重命名</p><figure class="highlight bash"><figcaption data-lang="bash"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token punctuation">&#123;</span><span class="token variable">$rename</span>:<span class="token punctuation">&#123;</span>old_field_name:new_field_name<span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span> <span class="token comment">#前面可以不加引号后面必须要加</span></pre></td></tr><tr><td data-num="2"></td><td><pre>db.mdb.update<span class="token punctuation">(</span><span class="token punctuation">&#123;</span>name:<span class="token string">"张三"</span><span class="token punctuation">&#125;</span>,<span class="token punctuation">&#123;</span><span class="token variable">$rename</span>:<span class="token punctuation">&#123;</span>course:<span class="token string">"sss"</span><span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span><span class="token punctuation">)</span></pre></td></tr></table></figure></li><li><h2 id="aggregate系列"><a class="anchor" href="#aggregate系列">#</a> <strong>aggregate 系列</strong></h2><ul><li><p><code>$group</code> 相关 <strong>（将集合中的文档分组，可用于统计结果）</strong></p><p><code>$sum</code> 、 <code>$avg</code> 、 <code>$max</code> 、 <code>$​​min</code> 相关语法：</p><figure class="highlight bash"><figcaption data-lang="bash"></figcaption><table><tr><td data-num="1"></td><td><pre>db.epms1.aggregate<span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token punctuation">&#123;</span><span class="token variable">$group</span>:<span class="token punctuation">&#123;</span>_id:<span class="token string">"<span class="token variable">$job</span>"</span>, num:<span class="token punctuation">&#123;</span><span class="token variable">$sum</span><span class="token builtin class-name">:</span><span class="token string">"<span class="token variable">$salary</span>"</span><span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span><span class="token punctuation">]</span><span class="token punctuation">)</span></pre></td></tr></table></figure><p><code>$addToSet</code> 、 <code>$​push</code> 与 update 系列规则相同</p><figure class="highlight bash"><figcaption data-lang="bash"></figcaption><table><tr><td data-num="1"></td><td><pre>db.mycol.aggregate<span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token punctuation">&#123;</span><span class="token variable">$group</span> <span class="token builtin class-name">:</span> <span class="token punctuation">&#123;</span>_id <span class="token builtin class-name">:</span> <span class="token string">"<span class="token variable">$by_user</span>"</span>, url <span class="token builtin class-name">:</span> <span class="token punctuation">&#123;</span><span class="token variable">$push</span><span class="token builtin class-name">:</span> <span class="token string">"<span class="token variable">$url</span>"</span><span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span><span class="token punctuation">]</span><span class="token punctuation">)</span></pre></td></tr></table></figure><p><strong>将所有人员信息全部 push 进去 ( <code>$$ROOT</code> )</strong></p><figure class="highlight bash"><figcaption data-lang="bash"></figcaption><table><tr><td data-num="1"></td><td><pre>db.persons.aggregate<span class="token punctuation">(</span><span class="token punctuation">[</span></pre></td></tr><tr><td data-num="2"></td><td><pre>    <span class="token punctuation">&#123;</span> </pre></td></tr><tr><td data-num="3"></td><td><pre>        <span class="token variable">$project</span> <span class="token builtin class-name">:</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="4"></td><td><pre>         _id <span class="token builtin class-name">:</span> <span class="token number">0</span> ,</pre></td></tr><tr><td data-num="5"></td><td><pre>       <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="6"></td><td><pre>    <span class="token punctuation">&#125;</span>,</pre></td></tr><tr><td data-num="7"></td><td><pre>   <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="8"></td><td><pre>        <span class="token variable">$group</span>:<span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="9"></td><td><pre>            _id:<span class="token punctuation">&#123;</span>country:<span class="token string">"<span class="token variable">$country</span>"</span>, m: <span class="token string">"<span class="token variable">$m</span>"</span><span class="token punctuation">&#125;</span>,</pre></td></tr><tr><td data-num="10"></td><td><pre>        total:<span class="token punctuation">&#123;</span><span class="token variable">$push</span><span class="token builtin class-name">:</span><span class="token string">"<span class="token variable">$$</span>ROOT"</span><span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="11"></td><td><pre>        <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="12"></td><td><pre>   <span class="token punctuation">&#125;</span>,</pre></td></tr><tr><td data-num="13"></td><td><pre>    <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="14"></td><td><pre>        <span class="token variable">$match</span>:<span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="15"></td><td><pre>            <span class="token string">"_id.m"</span>:<span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="16"></td><td><pre>                <span class="token variable">$gt</span>:90</pre></td></tr><tr><td data-num="17"></td><td><pre>            <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="18"></td><td><pre>        <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="19"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="20"></td><td><pre><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr></table></figure><p><code>$first</code> ( <code>$​last</code> ) 根据资源文档的排序获取第一个 (最后一个) 文档数据。</p><figure class="highlight bash"><figcaption data-lang="bash"></figcaption><table><tr><td data-num="1"></td><td><pre>db.mycol.aggregate<span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token punctuation">&#123;</span><span class="token variable">$group</span> <span class="token builtin class-name">:</span> <span class="token punctuation">&#123;</span>_id <span class="token builtin class-name">:</span> <span class="token string">"<span class="token variable">$by_user</span>"</span>, last_url <span class="token builtin class-name">:</span> <span class="token punctuation">&#123;</span><span class="token variable">$last</span> <span class="token builtin class-name">:</span> <span class="token string">"<span class="token variable">$url</span>"</span><span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span><span class="token punctuation">]</span><span class="token punctuation">)</span></pre></td></tr></table></figure></li><li><p><code>$project</code> 相关 ** （修改输入文档的结构。可以用来重命名、增加或删除域，也可以用于创建计算结果以及嵌套文档）**</p><figure class="highlight bash"><figcaption data-lang="bash"></figcaption><table><tr><td data-num="1"></td><td><pre>db.epms1.aggregate<span class="token punctuation">(</span></pre></td></tr><tr><td data-num="2"></td><td><pre>    <span class="token punctuation">&#123;</span> <span class="token variable">$project</span> <span class="token builtin class-name">:</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="3"></td><td><pre>        _id <span class="token builtin class-name">:</span> <span class="token number">0</span> ,</pre></td></tr><tr><td data-num="4"></td><td><pre>        name <span class="token builtin class-name">:</span> <span class="token number">1</span> ,</pre></td></tr><tr><td data-num="5"></td><td><pre>    <span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="6"></td><td><pre> <span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr></table></figure><p>注：除了_id:0 可以使用，其他都必须统一为 0 或者统一为 1，（选择的属性，要么都显示，要么都不显示，不能混用）</p><p><span class="exturl" data-url="aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzE4OTQ4MzU5L2FydGljbGUvZGV0YWlscy84ODc3NzMxNA==">其他操作</span></p><p><strong>把 weight 重命名为 newWeight</strong></p><figure class="highlight bash"><figcaption data-lang="bash"></figcaption><table><tr><td data-num="1"></td><td><pre>db.test.aggregate<span class="token punctuation">(</span></pre></td></tr><tr><td data-num="2"></td><td><pre>    <span class="token punctuation">&#123;</span> <span class="token variable">$project</span> <span class="token builtin class-name">:</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="3"></td><td><pre>         _id <span class="token builtin class-name">:</span> <span class="token number">0</span> ,</pre></td></tr><tr><td data-num="4"></td><td><pre>        name <span class="token builtin class-name">:</span> <span class="token number">1</span>  ,</pre></td></tr><tr><td data-num="5"></td><td><pre>        weight <span class="token builtin class-name">:</span> <span class="token number">1</span> ,</pre></td></tr><tr><td data-num="6"></td><td><pre>        newWeight <span class="token builtin class-name">:</span> <span class="token string">"<span class="token variable">$weight</span>"</span></pre></td></tr><tr><td data-num="7"></td><td><pre>    <span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="8"></td><td><pre> <span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr></table></figure><p><strong>使用 <code>＄add</code> 给 weight 字段的值加 10，然后将结果赋值给一个新的字段:newWeight</strong></p><figure class="highlight bash"><figcaption data-lang="bash"></figcaption><table><tr><td data-num="1"></td><td><pre>db.test.aggregate<span class="token punctuation">(</span></pre></td></tr><tr><td data-num="2"></td><td><pre>    <span class="token punctuation">&#123;</span> <span class="token variable">$project</span> <span class="token builtin class-name">:</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="3"></td><td><pre>         _id <span class="token builtin class-name">:</span> <span class="token number">0</span> ,</pre></td></tr><tr><td data-num="4"></td><td><pre>        name <span class="token builtin class-name">:</span> <span class="token number">1</span>  ,</pre></td></tr><tr><td data-num="5"></td><td><pre>        weight <span class="token builtin class-name">:</span> <span class="token number">1</span> ,</pre></td></tr><tr><td data-num="6"></td><td><pre>        newWeight <span class="token builtin class-name">:</span> <span class="token punctuation">&#123;</span> <span class="token variable">$add</span>:<span class="token punctuation">[</span><span class="token string">"<span class="token variable">$weight</span>"</span>, <span class="token number">10</span><span class="token punctuation">]</span> <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="7"></td><td><pre>    <span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="8"></td><td><pre> <span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr></table></figure></li><li><p><code>$match</code> 相关 <strong>（过滤数据）</strong></p><figure class="highlight bash"><figcaption data-lang="bash"></figcaption><table><tr><td data-num="1"></td><td><pre>db.articles.aggregate<span class="token punctuation">(</span> <span class="token punctuation">[</span></pre></td></tr><tr><td data-num="2"></td><td><pre>                        <span class="token punctuation">&#123;</span> <span class="token variable">$match</span> <span class="token builtin class-name">:</span> <span class="token punctuation">&#123;</span> score <span class="token builtin class-name">:</span> <span class="token punctuation">&#123;</span> <span class="token variable">$gt</span> <span class="token builtin class-name">:</span> <span class="token number">70</span>, <span class="token variable">$lte</span> <span class="token builtin class-name">:</span> <span class="token number">90</span> <span class="token punctuation">&#125;</span> <span class="token punctuation">&#125;</span> <span class="token punctuation">&#125;</span>,</pre></td></tr><tr><td data-num="3"></td><td><pre>                        <span class="token punctuation">&#123;</span> <span class="token variable">$group</span><span class="token builtin class-name">:</span> <span class="token punctuation">&#123;</span> _id: null, count: <span class="token punctuation">&#123;</span> <span class="token variable">$sum</span><span class="token builtin class-name">:</span> <span class="token number">1</span> <span class="token punctuation">&#125;</span> <span class="token punctuation">&#125;</span> <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="4"></td><td><pre>                       <span class="token punctuation">]</span> <span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr></table></figure></li><li><p><code>$skip</code> / <code>$​limit</code> 相关</p><figure class="highlight bash"><figcaption data-lang="bash"></figcaption><table><tr><td data-num="1"></td><td><pre>db.article.aggregate<span class="token punctuation">(</span></pre></td></tr><tr><td data-num="2"></td><td><pre>    <span class="token punctuation">&#123;</span> <span class="token variable">$skip</span> <span class="token builtin class-name">:</span> <span class="token number">5</span> <span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr></table></figure></li><li><p><code>$unwind</code> 相关 （将文档中的某一个数组类型字段拆分成多条，每条包含数组中的一个值）</p><figure class="highlight bash"><figcaption data-lang="bash"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token comment"># 源数据</span></pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token punctuation">&#123;</span> <span class="token string">"_id"</span> <span class="token builtin class-name">:</span> <span class="token number">1</span>, <span class="token string">"item"</span> <span class="token builtin class-name">:</span> <span class="token string">"ABC1"</span>, sizes: <span class="token punctuation">[</span> <span class="token string">"S"</span>, <span class="token string">"M"</span>, <span class="token string">"L"</span><span class="token punctuation">]</span> <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="3"></td><td><pre></pre></td></tr><tr><td data-num="4"></td><td><pre>db.inventory.aggregate<span class="token punctuation">(</span> <span class="token punctuation">[</span> <span class="token punctuation">&#123;</span> <span class="token variable">$unwind</span> <span class="token builtin class-name">:</span> <span class="token string">"<span class="token variable">$sizes</span>"</span> <span class="token punctuation">&#125;</span> <span class="token punctuation">]</span> <span class="token punctuation">)</span></pre></td></tr><tr><td data-num="5"></td><td><pre></pre></td></tr><tr><td data-num="6"></td><td><pre><span class="token comment"># 结果：</span></pre></td></tr><tr><td data-num="7"></td><td><pre><span class="token punctuation">&#123;</span> <span class="token string">"_id"</span> <span class="token builtin class-name">:</span> <span class="token number">1</span>, <span class="token string">"item"</span> <span class="token builtin class-name">:</span> <span class="token string">"ABC1"</span>, <span class="token string">"sizes"</span> <span class="token builtin class-name">:</span> <span class="token string">"S"</span> <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="8"></td><td><pre><span class="token punctuation">&#123;</span> <span class="token string">"_id"</span> <span class="token builtin class-name">:</span> <span class="token number">1</span>, <span class="token string">"item"</span> <span class="token builtin class-name">:</span> <span class="token string">"ABC1"</span>, <span class="token string">"sizes"</span> <span class="token builtin class-name">:</span> <span class="token string">"M"</span> <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="9"></td><td><pre><span class="token punctuation">&#123;</span> <span class="token string">"_id"</span> <span class="token builtin class-name">:</span> <span class="token number">1</span>, <span class="token string">"item"</span> <span class="token builtin class-name">:</span> <span class="token string">"ABC1"</span>, <span class="token string">"sizes"</span> <span class="token builtin class-name">:</span> <span class="token string">"L"</span> <span class="token punctuation">&#125;</span></pre></td></tr></table></figure></li><li><p><code>$sort</code> 相关</p><p>内部用法与 find 系列相同</p></li><li><p><code>$geoNear</code> 相关 （输出接近某一地理位置的有序文档）</p><p><span class="exturl" data-url="aHR0cHM6Ly9ibG9nLnlhbmppbmdhbmcuY29tLz9wPTEzODE=">参考文档</span></p><figure class="highlight c"><figcaption data-lang="c"></figcaption><table><tr><td data-num="1"></td><td><pre>db<span class="token punctuation">.</span>space<span class="token punctuation">.</span><span class="token function">aggregate</span><span class="token punctuation">(</span><span class="token punctuation">[</span></pre></td></tr><tr><td data-num="2"></td><td><pre>    <span class="token punctuation">&#123;</span><span class="token string">"$geoNear"</span><span class="token operator">:</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="3"></td><td><pre>        <span class="token string">"near"</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token number">40</span><span class="token punctuation">,</span> <span class="token number">74</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token comment">//coordinates: [0,0] 经纬度</span></pre></td></tr><tr><td data-num="4"></td><td><pre>        <span class="token string">"distanceField"</span><span class="token operator">:</span> <span class="token string">"loc"</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="5"></td><td><pre>				<span class="token string">"query"</span><span class="token operator">:</span> <span class="token punctuation">&#123;</span> <span class="token string">"_id"</span><span class="token operator">:</span><span class="token string">"xxx"</span> <span class="token punctuation">&#125;</span><span class="token punctuation">,</span> <span class="token comment">// 查询条件</span></pre></td></tr><tr><td data-num="6"></td><td><pre>        <span class="token string">"maxDistance"</span><span class="token operator">:</span> <span class="token number">1</span><span class="token punctuation">,</span>  <span class="token comment">// 指定最大距离，不指定则为最大值</span></pre></td></tr><tr><td data-num="7"></td><td><pre>        <span class="token string">"num"</span><span class="token operator">:</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token comment">// 返回的行数 ，不写：默认返回所有</span></pre></td></tr><tr><td data-num="8"></td><td><pre>        <span class="token string">"spherical"</span><span class="token operator">:</span> true  <span class="token comment">//2dsphere 必须指定</span></pre></td></tr><tr><td data-num="9"></td><td><pre>    <span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="10"></td><td><pre><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">pretty</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr></table></figure></li></ul></li><li><h2 id="mapreduce"><a class="anchor" href="#mapreduce">#</a> <strong>MapReduce</strong></h2><p>查询 user 个数：</p><figure class="highlight bash"><figcaption data-lang="bash"></figcaption><table><tr><td data-num="1"></td><td><pre>db.shop.mapReduce<span class="token punctuation">(</span></pre></td></tr><tr><td data-num="2"></td><td><pre>   <span class="token function-name function">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>emit<span class="token punctuation">(</span>this.user,1<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span>,</pre></td></tr><tr><td data-num="3"></td><td><pre>   function<span class="token punctuation">(</span>key,values<span class="token punctuation">)</span><span class="token punctuation">&#123;</span>return Array.sum<span class="token punctuation">(</span>values<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span>,</pre></td></tr><tr><td data-num="4"></td><td><pre>   <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="5"></td><td><pre>      out:<span class="token punctuation">&#123;</span>inline:1<span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="6"></td><td><pre>   <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="7"></td><td><pre><span class="token punctuation">)</span>.find<span class="token punctuation">(</span><span class="token punctuation">)</span></pre></td></tr></table></figure><p>查询归并后并显示出来：</p><figure class="highlight bash"><figcaption data-lang="bash"></figcaption><table><tr><td data-num="1"></td><td><pre>db.sang_books.mapReduce<span class="token punctuation">(</span></pre></td></tr><tr><td data-num="2"></td><td><pre>	 <span class="token function-name function">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="3"></td><td><pre>		emit<span class="token punctuation">(</span>this.name, this.price<span class="token punctuation">)</span></pre></td></tr><tr><td data-num="4"></td><td><pre>	 <span class="token punctuation">&#125;</span>,</pre></td></tr><tr><td data-num="5"></td><td><pre>	 function<span class="token punctuation">(</span>key, values<span class="token punctuation">)</span><span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="6"></td><td><pre>		<span class="token builtin class-name">return</span> Array.sum<span class="token punctuation">(</span>values<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="7"></td><td><pre>	 <span class="token punctuation">&#125;</span>,</pre></td></tr><tr><td data-num="8"></td><td><pre>	 <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="9"></td><td><pre>		 out:<span class="token punctuation">&#123;</span>inline:1<span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="10"></td><td><pre>	 <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="11"></td><td><pre> <span class="token punctuation">)</span>.find<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token comment"># 加上 find 只会显示文档内容不会显示执行成功信息</span></pre></td></tr></table></figure><p>不指定文档的话将存储在临时文档中，指定文档就会输入进去（如果没有就创建）：</p><figure class="highlight bash"><figcaption data-lang="bash"></figcaption><table><tr><td data-num="1"></td><td><pre>var results <span class="token operator">=</span> db.sang_books.mapReduce<span class="token punctuation">(</span></pre></td></tr><tr><td data-num="2"></td><td><pre>	<span class="token function-name function">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="3"></td><td><pre>	   emit<span class="token punctuation">(</span>this.name, this.price<span class="token punctuation">)</span></pre></td></tr><tr><td data-num="4"></td><td><pre>	<span class="token punctuation">&#125;</span>,</pre></td></tr><tr><td data-num="5"></td><td><pre>	function<span class="token punctuation">(</span>key, values<span class="token punctuation">)</span><span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="6"></td><td><pre>	   <span class="token builtin class-name">return</span> Array.sum<span class="token punctuation">(</span>values<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="7"></td><td><pre>	<span class="token punctuation">&#125;</span>,</pre></td></tr><tr><td data-num="8"></td><td><pre>	<span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="9"></td><td><pre>		out:<span class="token string">"aa"</span></pre></td></tr><tr><td data-num="10"></td><td><pre>	<span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="11"></td><td><pre><span class="token punctuation">)</span></pre></td></tr></table></figure><p>查询到作者有多本书以逗号分隔：</p><figure class="highlight c"><figcaption data-lang="c"></figcaption><table><tr><td data-num="1"></td><td><pre>db<span class="token punctuation">.</span>sang_books<span class="token punctuation">.</span><span class="token function">mapReduce</span><span class="token punctuation">(</span></pre></td></tr><tr><td data-num="2"></td><td><pre>    <span class="token function">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span><span class="token function">emit</span><span class="token punctuation">(</span>this<span class="token punctuation">.</span>name<span class="token punctuation">,</span>this<span class="token punctuation">.</span>book<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="3"></td><td><pre>    <span class="token function">function</span><span class="token punctuation">(</span>key<span class="token punctuation">,</span>values<span class="token punctuation">)</span><span class="token punctuation">&#123;</span><span class="token keyword">return</span> values<span class="token punctuation">.</span><span class="token function">join</span><span class="token punctuation">(</span><span class="token string">","</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="4"></td><td><pre>    <span class="token punctuation">&#123;</span>out<span class="token operator">:</span><span class="token punctuation">&#123;</span><span class="token keyword">inline</span><span class="token operator">:</span><span class="token number">1</span><span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="5"></td><td><pre><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">find</span><span class="token punctuation">(</span><span class="token punctuation">)</span></pre></td></tr></table></figure><p>查询每个 user 的每种 sku 的数量</p><figure class="highlight bash"><figcaption data-lang="bash"></figcaption><table><tr><td data-num="1"></td><td><pre>db.shop.mapReduce<span class="token punctuation">(</span></pre></td></tr><tr><td data-num="2"></td><td><pre>   <span class="token function-name function">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="3"></td><td><pre>      emit<span class="token punctuation">(</span><span class="token punctuation">&#123;</span>user:this.user,sku:this.sku<span class="token punctuation">&#125;</span>,1<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="4"></td><td><pre>   <span class="token punctuation">&#125;</span>,</pre></td></tr><tr><td data-num="5"></td><td><pre>   function<span class="token punctuation">(</span>key,values<span class="token punctuation">)</span><span class="token punctuation">&#123;</span>return Array.sum<span class="token punctuation">(</span>values<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span>,</pre></td></tr><tr><td data-num="6"></td><td><pre>   <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="7"></td><td><pre>      out:<span class="token punctuation">&#123;</span>inline:1<span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="8"></td><td><pre>   <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="9"></td><td><pre><span class="token punctuation">)</span>.find<span class="token punctuation">(</span><span class="token punctuation">)</span></pre></td></tr></table></figure></li><li><h2 id="createindex索引"><a class="anchor" href="#createindex索引">#</a> <strong>createIndex () 索引</strong></h2><ul><li><p>索引的查和删</p><p>查看集合索引：</p><figure class="highlight bash"><figcaption data-lang="bash"></figcaption><table><tr><td data-num="1"></td><td><pre>db.col.getIndexes<span class="token punctuation">(</span><span class="token punctuation">)</span></pre></td></tr></table></figure><p>查看集合索引大小:</p><figure class="highlight bash"><figcaption data-lang="bash"></figcaption><table><tr><td data-num="1"></td><td><pre>db.col.totalIndexSize<span class="token punctuation">(</span><span class="token punctuation">)</span></pre></td></tr></table></figure><p>删除集合所有索引:</p><figure class="highlight bash"><figcaption data-lang="bash"></figcaption><table><tr><td data-num="1"></td><td><pre>db.col.dropIndexes<span class="token punctuation">(</span><span class="token punctuation">)</span></pre></td></tr></table></figure><p>删除集合指定索引:</p><figure class="highlight bash"><figcaption data-lang="bash"></figcaption><table><tr><td data-num="1"></td><td><pre>db.col.dropIndex<span class="token punctuation">(</span><span class="token string">"name"</span><span class="token punctuation">)</span></pre></td></tr></table></figure></li><li><p>常用索引类型</p><p>复合索引：</p><figure class="highlight c"><figcaption data-lang="c"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token comment">// 索引命名 &#123;name: "inventory_idx"&#125; (缺省情况下，索引名以键名加上其创建顺序 (1：升序  或者  -1：降序) 组合而成。)</span></pre></td></tr><tr><td data-num="2"></td><td><pre>db<span class="token punctuation">.</span>products<span class="token punctuation">.</span><span class="token function">createIndex</span><span class="token punctuation">(</span> <span class="token punctuation">&#123;</span> item<span class="token operator">:</span> <span class="token number">1</span><span class="token punctuation">,</span> quantity<span class="token operator">:</span> <span class="token operator">-</span><span class="token number">1</span> <span class="token punctuation">&#125;</span> <span class="token punctuation">,</span> <span class="token punctuation">&#123;</span> name<span class="token operator">:</span> <span class="token string">"inventory_idx"</span> <span class="token punctuation">&#125;</span> <span class="token punctuation">)</span></pre></td></tr></table></figure><p>多键索引:</p><figure class="highlight c"><figcaption data-lang="c"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token comment">// 是建在数组上的索引，在 mongoDB 的 document 中，有些字段的值为数组，多键索引就是为了提高查询这些数组的效率</span></pre></td></tr><tr><td data-num="2"></td><td><pre>db<span class="token punctuation">.</span>classes<span class="token punctuation">.</span><span class="token function">insertMany</span><span class="token punctuation">(</span><span class="token punctuation">[</span></pre></td></tr><tr><td data-num="3"></td><td><pre>     <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="4"></td><td><pre>         <span class="token string">"classname"</span><span class="token operator">:</span><span class="token string">"class1"</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="5"></td><td><pre>         <span class="token string">"students"</span><span class="token operator">:</span><span class="token punctuation">[</span><span class="token punctuation">&#123;</span>name<span class="token operator">:</span><span class="token string">'jack'</span><span class="token punctuation">,</span>age<span class="token operator">:</span><span class="token number">20</span><span class="token punctuation">&#125;</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="6"></td><td><pre>                    <span class="token punctuation">&#123;</span>name<span class="token operator">:</span><span class="token string">'tom'</span><span class="token punctuation">,</span>age<span class="token operator">:</span><span class="token number">22</span><span class="token punctuation">&#125;</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="7"></td><td><pre>                    <span class="token punctuation">&#123;</span>name<span class="token operator">:</span><span class="token string">'lilei'</span><span class="token punctuation">,</span>age<span class="token operator">:</span><span class="token number">25</span><span class="token punctuation">&#125;</span><span class="token punctuation">]</span></pre></td></tr><tr><td data-num="8"></td><td><pre>      <span class="token punctuation">&#125;</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="9"></td><td><pre>      <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="10"></td><td><pre>         <span class="token string">"classname"</span><span class="token operator">:</span><span class="token string">"class2"</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="11"></td><td><pre>         <span class="token string">"students"</span><span class="token operator">:</span><span class="token punctuation">[</span><span class="token punctuation">&#123;</span>name<span class="token operator">:</span><span class="token string">'lucy'</span><span class="token punctuation">,</span>age<span class="token operator">:</span><span class="token number">20</span><span class="token punctuation">&#125;</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="12"></td><td><pre>                    <span class="token punctuation">&#123;</span>name<span class="token operator">:</span><span class="token string">'jim'</span><span class="token punctuation">,</span>age<span class="token operator">:</span><span class="token number">23</span><span class="token punctuation">&#125;</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="13"></td><td><pre>                    <span class="token punctuation">&#123;</span>name<span class="token operator">:</span><span class="token string">'jarry'</span><span class="token punctuation">,</span>age<span class="token operator">:</span><span class="token number">26</span><span class="token punctuation">&#125;</span><span class="token punctuation">]</span></pre></td></tr><tr><td data-num="14"></td><td><pre>      <span class="token punctuation">&#125;</span><span class="token punctuation">]</span></pre></td></tr><tr><td data-num="15"></td><td><pre>  <span class="token punctuation">)</span></pre></td></tr><tr><td data-num="16"></td><td><pre>db<span class="token punctuation">.</span>classes<span class="token punctuation">.</span><span class="token function">createIndex</span><span class="token punctuation">(</span><span class="token punctuation">&#123;</span><span class="token string">'students.age'</span><span class="token operator">:</span><span class="token number">1</span><span class="token punctuation">&#125;</span><span class="token punctuation">)</span></pre></td></tr></table></figure><p>哈希索引:</p><figure class="highlight c"><figcaption data-lang="c"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token comment">// 就是将 field 的值进行 hash 计算后作为索引，其强大之处在于实现 O (1) 查找，</span></pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token comment">// 当然用哈希索引最主要的功能也就是实现定值查找，对于经常需要排序或查询范围查询的集合不要使用哈希索引</span></pre></td></tr><tr><td data-num="3"></td><td><pre>db<span class="token punctuation">.</span>col<span class="token punctuation">.</span><span class="token function">createIndex</span><span class="token punctuation">(</span><span class="token punctuation">&#123;</span>name<span class="token operator">:</span><span class="token string">"hashed"</span><span class="token punctuation">&#125;</span><span class="token punctuation">)</span></pre></td></tr></table></figure></li><li><p>常用索引属性：</p><p>唯一索引:</p><figure class="highlight c"><figcaption data-lang="c"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token comment">// 用于为 collection 添加唯一约束，即强制要求 collection 中的索引字段没有重复值</span></pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token comment">// 在 userinfos 的 name 字段添加唯一索引</span></pre></td></tr><tr><td data-num="3"></td><td><pre>db<span class="token punctuation">.</span>userinfos<span class="token punctuation">.</span><span class="token function">createIndex</span><span class="token punctuation">(</span><span class="token punctuation">&#123;</span>name<span class="token operator">:</span><span class="token number">1</span><span class="token punctuation">&#125;</span><span class="token punctuation">,</span><span class="token punctuation">&#123;</span>unique<span class="token operator">:</span>true<span class="token punctuation">&#125;</span><span class="token punctuation">)</span></pre></td></tr></table></figure><p>局部索引:</p><figure class="highlight c"><figcaption data-lang="c"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token comment">// 只对 collection 的一部分添加索引。创建索引的时候，根据过滤条件判断是否对 document 添加索引，</span></pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token comment">// 对于没有添加索引的文档查找时采用的全表扫描，对添加了索引的文档查找时使用索引</span></pre></td></tr><tr><td data-num="3"></td><td><pre><span class="token comment">//userinfos 集合中 age>25 的部分添加 age 字段索引</span></pre></td></tr><tr><td data-num="4"></td><td><pre>    db<span class="token punctuation">.</span>userinfos<span class="token punctuation">.</span><span class="token function">createIndex</span><span class="token punctuation">(</span></pre></td></tr><tr><td data-num="5"></td><td><pre>        <span class="token punctuation">&#123;</span>age<span class="token operator">:</span><span class="token number">1</span><span class="token punctuation">&#125;</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="6"></td><td><pre>        <span class="token punctuation">&#123;</span> partialFilterExpression<span class="token operator">:</span> <span class="token punctuation">&#123;</span>age<span class="token operator">:</span><span class="token punctuation">&#123;</span>$gt<span class="token operator">:</span> <span class="token number">25</span> <span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="7"></td><td><pre>    <span class="token punctuation">)</span></pre></td></tr><tr><td data-num="8"></td><td><pre><span class="token comment">// 查询 age&lt;25 的 document 时，因为 age&lt;25 的部分没有索引，会全表扫描查找 (stage:COLLSCAN)</span></pre></td></tr><tr><td data-num="9"></td><td><pre>    db<span class="token punctuation">.</span>userinfos<span class="token punctuation">.</span><span class="token function">find</span><span class="token punctuation">(</span><span class="token punctuation">&#123;</span>age<span class="token operator">:</span><span class="token number">23</span><span class="token punctuation">&#125;</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="10"></td><td><pre><span class="token comment">// 查询 age>25 的 document 时，因为 age>25 的部分创建了索引，会使用索引进行查找 (stage:IXSCAN)</span></pre></td></tr><tr><td data-num="11"></td><td><pre>    db<span class="token punctuation">.</span>userinfos<span class="token punctuation">.</span><span class="token function">find</span><span class="token punctuation">(</span><span class="token punctuation">&#123;</span>age<span class="token operator">:</span><span class="token number">26</span><span class="token punctuation">&#125;</span><span class="token punctuation">)</span></pre></td></tr></table></figure><p>稀疏索引:</p><figure class="highlight c"><figcaption data-lang="c"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token comment">// 当 document 包含 address 字段时才会创建索引</span></pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token comment">// 创建在 address 上创建稀疏索引</span></pre></td></tr><tr><td data-num="3"></td><td><pre>　　db<span class="token punctuation">.</span>userinfos<span class="token punctuation">.</span><span class="token function">createIndex</span><span class="token punctuation">(</span><span class="token punctuation">&#123;</span>address<span class="token operator">:</span><span class="token number">1</span><span class="token punctuation">&#125;</span><span class="token punctuation">,</span><span class="token punctuation">&#123;</span>sparse<span class="token operator">:</span>true<span class="token punctuation">&#125;</span><span class="token punctuation">)</span></pre></td></tr></table></figure><p>TTL 索引:</p><figure class="highlight c"><figcaption data-lang="c"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token comment">// (TTL indexes) 是一种特殊的单键索引，用于设置 document 的过期时间，mongoDB 会在 document 过期后将其删除，</span></pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token comment">//TTL 非常容易实现类似缓存过期策略的功能</span></pre></td></tr><tr><td data-num="3"></td><td><pre><span class="token comment">// 添加测试数据</span></pre></td></tr><tr><td data-num="4"></td><td><pre>db<span class="token punctuation">.</span>logs<span class="token punctuation">.</span><span class="token function">insertMany</span><span class="token punctuation">(</span><span class="token punctuation">[</span></pre></td></tr><tr><td data-num="5"></td><td><pre>       <span class="token punctuation">&#123;</span>_id<span class="token operator">:</span><span class="token number">1</span><span class="token punctuation">,</span>createtime<span class="token operator">:</span>new <span class="token function">Date</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>msg<span class="token operator">:</span><span class="token string">"log1"</span><span class="token punctuation">&#125;</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="6"></td><td><pre>       <span class="token punctuation">&#123;</span>_id<span class="token operator">:</span><span class="token number">2</span><span class="token punctuation">,</span>createtime<span class="token operator">:</span>new <span class="token function">Date</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>msg<span class="token operator">:</span><span class="token string">"log2"</span><span class="token punctuation">&#125;</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="7"></td><td><pre>       <span class="token punctuation">&#123;</span>_id<span class="token operator">:</span><span class="token number">3</span><span class="token punctuation">,</span>createtime<span class="token operator">:</span>new <span class="token function">Date</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>msg<span class="token operator">:</span><span class="token string">"log3"</span><span class="token punctuation">&#125;</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="8"></td><td><pre>       <span class="token punctuation">&#123;</span>_id<span class="token operator">:</span><span class="token number">4</span><span class="token punctuation">,</span>createtime<span class="token operator">:</span>new <span class="token function">Date</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>msg<span class="token operator">:</span><span class="token string">"log4"</span><span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="9"></td><td><pre>       <span class="token punctuation">]</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="10"></td><td><pre>       <span class="token comment">// 在 createtime 字段添加 TTL 索引，过期时间是 120s</span></pre></td></tr><tr><td data-num="11"></td><td><pre>       db<span class="token punctuation">.</span>logs<span class="token punctuation">.</span><span class="token function">createIndex</span><span class="token punctuation">(</span><span class="token punctuation">&#123;</span>createtime<span class="token operator">:</span><span class="token number">1</span><span class="token punctuation">&#125;</span><span class="token punctuation">,</span> <span class="token punctuation">&#123;</span> expireAfterSeconds<span class="token operator">:</span> <span class="token number">120</span> <span class="token punctuation">&#125;</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="12"></td><td><pre><span class="token comment">//logs 中的 document 在创建后的 120s 后过期，会被 mongoDB 自动删除</span></pre></td></tr></table></figure><p>文本索引：</p><figure class="highlight c"><figcaption data-lang="c"></figcaption><table><tr><td data-num="1"></td><td><pre>db<span class="token punctuation">.</span>collection<span class="token punctuation">.</span><span class="token function">createIndex</span><span class="token punctuation">(</span></pre></td></tr><tr><td data-num="2"></td><td><pre>  <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="3"></td><td><pre>     title<span class="token operator">:</span><span class="token string">'text'</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="4"></td><td><pre>     tags：<span class="token string">'text'</span></pre></td></tr><tr><td data-num="5"></td><td><pre>  <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="6"></td><td><pre><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="7"></td><td><pre></pre></td></tr><tr><td data-num="8"></td><td><pre>搜索一下含有 educoder<span class="token punctuation">.</span>net 的文章：</pre></td></tr><tr><td data-num="9"></td><td><pre>db<span class="token punctuation">.</span>collection<span class="token punctuation">.</span><span class="token function">find</span><span class="token punctuation">(</span><span class="token punctuation">&#123;</span>$text<span class="token operator">:</span><span class="token punctuation">&#123;</span>$search<span class="token operator">:</span><span class="token string">'educoder.net'</span><span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span><span class="token punctuation">)</span></pre></td></tr></table></figure><ul><li>search 后的关键词可以有多个，关键词之间的分隔符可以是多种字符，例如空格、下划线、逗号、加号等，但不能是 &quot;-&quot; 和 &quot;&quot;，因为这两个符号会有其他用途。搜索的多个关键字是 or 的关系，除非你的关键字包含&quot;-&quot;``</li><li>匹配时不是完整的单词匹配，相似的词也可以匹配到；</li></ul></li><li><p>地理空间索引：</p><p><span class="exturl" data-url="aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3lvbmdnYW5nNy9hcnRpY2xlL2RldGFpbHMvMjgxMDk0NjM=">参考文档</span></p><p><span class="exturl" data-url="aHR0cHM6Ly93d3cuZG9jczRkZXYuY29tL2RvY3MvemgvbW9uZ29kYi92My42L3JlZmVyZW5jZS9yZWZlcmVuY2Utb3BlcmF0b3ItcXVlcnktZ2VvSW50ZXJzZWN0cy5odG1s">参考文档 2</span></p><p>建立索引：(也可以建立组合索引)</p><figure class="highlight c"><figcaption data-lang="c"></figcaption><table><tr><td data-num="1"></td><td><pre>db<span class="token punctuation">.</span>places<span class="token punctuation">.</span><span class="token function">ensureIndex</span><span class="token punctuation">(</span> <span class="token punctuation">&#123;</span> loc <span class="token operator">:</span> <span class="token string">"2dsphere"</span> <span class="token punctuation">&#125;</span> <span class="token punctuation">)</span></pre></td></tr></table></figure><p>查询多边形范围的值：</p><figure class="highlight c"><figcaption data-lang="c"></figcaption><table><tr><td data-num="1"></td><td><pre>db<span class="token punctuation">.</span>places<span class="token punctuation">.</span><span class="token function">find</span><span class="token punctuation">(</span> <span class="token punctuation">&#123;</span> loc <span class="token operator">:</span></pre></td></tr><tr><td data-num="2"></td><td><pre>                  <span class="token punctuation">&#123;</span> $geoWithin <span class="token operator">:</span></pre></td></tr><tr><td data-num="3"></td><td><pre>                    <span class="token punctuation">&#123;</span> $geometry <span class="token operator">:</span></pre></td></tr><tr><td data-num="4"></td><td><pre>                      <span class="token punctuation">&#123;</span> type <span class="token operator">:</span> <span class="token string">"Polygon"</span> <span class="token punctuation">,</span></pre></td></tr><tr><td data-num="5"></td><td><pre>                        coordinates <span class="token operator">:</span> <span class="token punctuation">[</span> <span class="token punctuation">[</span></pre></td></tr><tr><td data-num="6"></td><td><pre>                                          <span class="token punctuation">[</span> <span class="token number">0</span> <span class="token punctuation">,</span> <span class="token number">0</span> <span class="token punctuation">]</span> <span class="token punctuation">,</span></pre></td></tr><tr><td data-num="7"></td><td><pre>                                          <span class="token punctuation">[</span> <span class="token number">3</span> <span class="token punctuation">,</span> <span class="token number">6</span> <span class="token punctuation">]</span> <span class="token punctuation">,</span></pre></td></tr><tr><td data-num="8"></td><td><pre>                                          <span class="token punctuation">[</span> <span class="token number">6</span> <span class="token punctuation">,</span> <span class="token number">1</span> <span class="token punctuation">]</span> <span class="token punctuation">,</span></pre></td></tr><tr><td data-num="9"></td><td><pre>                                          <span class="token punctuation">[</span> <span class="token number">0</span> <span class="token punctuation">,</span> <span class="token number">0</span> <span class="token punctuation">]</span></pre></td></tr><tr><td data-num="10"></td><td><pre>                                        <span class="token punctuation">]</span> <span class="token punctuation">]</span></pre></td></tr><tr><td data-num="11"></td><td><pre>                <span class="token punctuation">&#125;</span> <span class="token punctuation">&#125;</span> <span class="token punctuation">&#125;</span> <span class="token punctuation">&#125;</span> <span class="token punctuation">)</span></pre></td></tr></table></figure><p>查询附近的值:</p><figure class="highlight c"><figcaption data-lang="c"></figcaption><table><tr><td data-num="1"></td><td><pre>db<span class="token punctuation">.</span>places<span class="token punctuation">.</span><span class="token function">find</span><span class="token punctuation">(</span> <span class="token punctuation">&#123;</span> loc <span class="token operator">:</span></pre></td></tr><tr><td data-num="2"></td><td><pre>                         <span class="token punctuation">&#123;</span> $near <span class="token operator">:</span></pre></td></tr><tr><td data-num="3"></td><td><pre>                           <span class="token punctuation">&#123;</span> $geometry <span class="token operator">:</span></pre></td></tr><tr><td data-num="4"></td><td><pre>                              <span class="token punctuation">&#123;</span> type <span class="token operator">:</span> <span class="token string">"Point"</span> <span class="token punctuation">,</span></pre></td></tr><tr><td data-num="5"></td><td><pre>                                coordinates <span class="token operator">:</span> <span class="token punctuation">[</span> <span class="token operator">&lt;</span>longitude<span class="token operator">></span> <span class="token punctuation">,</span> <span class="token operator">&lt;</span>latitude<span class="token operator">></span> <span class="token punctuation">]</span> <span class="token punctuation">&#125;</span> <span class="token punctuation">,</span></pre></td></tr><tr><td data-num="6"></td><td><pre>                             $maxDistance <span class="token operator">:</span> <span class="token operator">&lt;</span>distance in meters<span class="token operator">></span></pre></td></tr><tr><td data-num="7"></td><td><pre>                      <span class="token punctuation">&#125;</span> <span class="token punctuation">&#125;</span> <span class="token punctuation">&#125;</span> <span class="token punctuation">)</span></pre></td></tr></table></figure><p>查询圆形内的值:</p><figure class="highlight c"><figcaption data-lang="c"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token comment">//[-88, 30] 为经纬度，  10 为半径  球形范围</span></pre></td></tr><tr><td data-num="2"></td><td><pre>db<span class="token punctuation">.</span>places<span class="token punctuation">.</span><span class="token function">find</span><span class="token punctuation">(</span> <span class="token punctuation">&#123;</span> loc <span class="token operator">:</span></pre></td></tr><tr><td data-num="3"></td><td><pre>                  <span class="token punctuation">&#123;</span> $geoWithin <span class="token operator">:</span></pre></td></tr><tr><td data-num="4"></td><td><pre>                    <span class="token punctuation">&#123;</span> $centerSphere <span class="token operator">:</span></pre></td></tr><tr><td data-num="5"></td><td><pre>                       <span class="token punctuation">[</span> <span class="token punctuation">[</span> <span class="token operator">-</span><span class="token number">88</span> <span class="token punctuation">,</span> <span class="token number">30</span> <span class="token punctuation">]</span> <span class="token punctuation">,</span> <span class="token number">10</span> <span class="token punctuation">]</span></pre></td></tr><tr><td data-num="6"></td><td><pre>                <span class="token punctuation">&#125;</span> <span class="token punctuation">&#125;</span> <span class="token punctuation">&#125;</span> <span class="token punctuation">)</span></pre></td></tr><tr><td data-num="7"></td><td><pre><span class="token comment">//2d 圆形范围</span></pre></td></tr><tr><td data-num="8"></td><td><pre>db<span class="token punctuation">.</span>space<span class="token punctuation">.</span><span class="token function">find</span><span class="token punctuation">(</span></pre></td></tr><tr><td data-num="9"></td><td><pre>    <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="10"></td><td><pre>      <span class="token string">"loc"</span><span class="token operator">:</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="11"></td><td><pre>         $geoWithin<span class="token operator">:</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="12"></td><td><pre>             $center<span class="token operator">:</span> <span class="token punctuation">[</span> <span class="token punctuation">[</span> <span class="token number">40</span><span class="token punctuation">,</span> <span class="token number">70</span><span class="token punctuation">]</span> <span class="token punctuation">,</span> <span class="token number">10</span> <span class="token punctuation">]</span> </pre></td></tr><tr><td data-num="13"></td><td><pre>         <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="14"></td><td><pre>      <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="15"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="16"></td><td><pre><span class="token punctuation">)</span></pre></td></tr></table></figure><p>查找矩形范围：</p><figure class="highlight c"><figcaption data-lang="c"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token comment">// 左上角和右下角</span></pre></td></tr><tr><td data-num="2"></td><td><pre>box <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">[</span><span class="token number">39</span><span class="token punctuation">,</span><span class="token number">39</span><span class="token punctuation">]</span><span class="token punctuation">,</span><span class="token punctuation">[</span><span class="token number">40</span><span class="token punctuation">,</span><span class="token number">74</span><span class="token punctuation">]</span><span class="token punctuation">]</span></pre></td></tr><tr><td data-num="3"></td><td><pre>db<span class="token punctuation">.</span>space<span class="token punctuation">.</span><span class="token function">find</span><span class="token punctuation">(</span><span class="token punctuation">&#123;</span><span class="token string">"loc"</span><span class="token operator">:</span><span class="token punctuation">&#123;</span>$within<span class="token operator">:</span><span class="token punctuation">&#123;</span><span class="token string">"$box"</span><span class="token operator">:</span>box<span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span><span class="token punctuation">)</span></pre></td></tr></table></figure><ul><li><p>runCommand 方法：</p><ul><li>geoNear ：我们要查询的集合名称；</li><li>near ：就是基于那个点进行搜索，这里是我们的搜索点 “长沙站”；</li><li>spherical ：是个布尔值，如果为 true，表示将计算实际的物理距离，比如两点之间有多少 km，若为 false，则会基于点的单位进行计算 ；</li><li>minDistance ：搜索的最小距离，这里的单位是米 ；</li><li>maxDistance ：搜索的最大距离</li></ul><figure class="highlight c"><figcaption data-lang="c"></figcaption><table><tr><td data-num="1"></td><td><pre>db<span class="token punctuation">.</span><span class="token function">runCommand</span><span class="token punctuation">(</span><span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="2"></td><td><pre>    geoNear<span class="token operator">:</span><span class="token string">'locations'</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="3"></td><td><pre>    near<span class="token operator">:</span><span class="token punctuation">&#123;</span>type<span class="token operator">:</span><span class="token string">'Point'</span><span class="token punctuation">,</span>coordinates<span class="token operator">:</span><span class="token punctuation">[</span><span class="token number">113.018987</span><span class="token punctuation">,</span><span class="token number">28.201215</span><span class="token punctuation">]</span><span class="token punctuation">&#125;</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="4"></td><td><pre>    spherical<span class="token operator">:</span>true<span class="token punctuation">,</span></pre></td></tr><tr><td data-num="5"></td><td><pre>    minDistance<span class="token operator">:</span><span class="token number">1000</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="6"></td><td><pre>    maxDistance<span class="token operator">:</span><span class="token number">8000</span></pre></td></tr><tr><td data-num="7"></td><td><pre><span class="token punctuation">&#125;</span><span class="token punctuation">)</span></pre></td></tr></table></figure></li></ul></li></ul></li><li><h2 id="创建仓库管理员"><a class="anchor" href="#创建仓库管理员">#</a> <strong>创建仓库管理员</strong></h2><figure class="highlight bash"><figcaption data-lang="bash"></figcaption><table><tr><td data-num="1"></td><td><pre>use admin</pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token comment"># 在数据库 admin 中，创建管理员用户 abc，密码为 123，拥有 root 权限</span></pre></td></tr><tr><td data-num="3"></td><td><pre>db.createUser<span class="token punctuation">(</span><span class="token punctuation">&#123;</span>user:<span class="token string">"abc"</span>,pwd:<span class="token string">"123"</span>,roles:<span class="token punctuation">[</span><span class="token punctuation">&#123;</span>role:<span class="token string">"root"</span>,db:<span class="token string">"admin"</span><span class="token punctuation">&#125;</span><span class="token punctuation">]</span><span class="token punctuation">&#125;</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="4"></td><td><pre><span class="token comment"># 验证管理员用户是否存在：返回为 1 说明成功</span></pre></td></tr><tr><td data-num="5"></td><td><pre>db.auth<span class="token punctuation">(</span><span class="token string">"abc"</span>,<span class="token string">"123"</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="6"></td><td><pre><span class="token comment"># 在 admin 数据库内查看创建的用户</span></pre></td></tr><tr><td data-num="7"></td><td><pre>show <span class="token function">users</span></pre></td></tr></table></figure><p>用新身份进入 mongo：</p><figure class="highlight bash"><figcaption data-lang="bash"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token comment"># 先关闭现在有的数据库服务</span></pre></td></tr><tr><td data-num="2"></td><td><pre>use admin </pre></td></tr><tr><td data-num="3"></td><td><pre>db.shutdownServer<span class="token punctuation">(</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="4"></td><td><pre><span class="token comment"># 重新启动 mongod 服务</span></pre></td></tr><tr><td data-num="5"></td><td><pre>mongod --auth --port <span class="token number">27017</span> --dbpath /data/db --logpath /tmp/mongodb.log --fork</pre></td></tr><tr><td data-num="6"></td><td><pre></pre></td></tr><tr><td data-num="7"></td><td><pre>auth: 开启身份验证；</pre></td></tr><tr><td data-num="8"></td><td><pre></pre></td></tr><tr><td data-num="9"></td><td><pre>dbpath: 指定数据存放路径；</pre></td></tr><tr><td data-num="10"></td><td><pre></pre></td></tr><tr><td data-num="11"></td><td><pre>logpath: 指定日志文件输出路径；</pre></td></tr><tr><td data-num="12"></td><td><pre></pre></td></tr><tr><td data-num="13"></td><td><pre>fork: 后台运行</pre></td></tr><tr><td data-num="14"></td><td><pre></pre></td></tr><tr><td data-num="15"></td><td><pre><span class="token comment"># 管理员登录数据库</span></pre></td></tr><tr><td data-num="16"></td><td><pre>mongo -uabc -p123 admin</pre></td></tr><tr><td data-num="17"></td><td><pre></pre></td></tr><tr><td data-num="18"></td><td><pre><span class="token comment"># 删除管理员用户 abc 命令如下：</span></pre></td></tr><tr><td data-num="19"></td><td><pre>db.system.users.remove<span class="token punctuation">(</span><span class="token punctuation">&#123;</span>user:<span class="token string">"abc"</span><span class="token punctuation">&#125;</span><span class="token punctuation">)</span></pre></td></tr></table></figure><ul><li><p>情况二：在受限的情况下验证身份；</p><p>开启身份验证后，我们使用命令 <code>mongo</code> 直接连接数据库，虽然也能成功连接，但是在进行数据库操作如 <code>show dbs</code> 时会受到限制：</p></li></ul><p><span class="exturl" data-url="aHR0cHM6Ly9kYXRhLmVkdWNvZGVyLm5ldC9hcGkvYXR0YWNobWVudHMvMjA3ODQy">https://data.educoder.net/api/attachments/207842</span></p><p>这是我们就要进入到 <code>admin</code> 数据库，去进行身份验证：返回数字 <code>1</code> 说明验证成功， <code>0</code> 说明失败，验证成功后将拥有管理员权限</p><pre><code>use admindb.auth(&quot;abc&quot;,&quot;123&quot;)
</code></pre></li><li><p><strong>创建普通用户</strong></p><p>创建用户： <code>user2</code> ，密码： <code>user2</code> ，对数据库 <code>test2</code> 有读写权限，对数据库 <code>test</code> 有只读权限</p><figure class="highlight bash"><figcaption data-lang="bash"></figcaption><table><tr><td data-num="1"></td><td><pre>use test2</pre></td></tr><tr><td data-num="2"></td><td><pre>db.createUser<span class="token punctuation">(</span><span class="token punctuation">&#123;</span>user:<span class="token string">"user2"</span>,pwd:<span class="token string">"user2"</span>,roles:<span class="token punctuation">[</span><span class="token punctuation">&#123;</span>role:<span class="token string">"readWrite"</span>,db:<span class="token string">"test2"</span><span class="token punctuation">&#125;</span>,<span class="token punctuation">&#123;</span>role:<span class="token string">"read"</span>,db:<span class="token string">"test"</span><span class="token punctuation">&#125;</span><span class="token punctuation">]</span><span class="token punctuation">&#125;</span><span class="token punctuation">)</span></pre></td></tr></table></figure><p><strong>删除用户</strong></p><figure class="highlight bash"><figcaption data-lang="bash"></figcaption><table><tr><td data-num="1"></td><td><pre>use test2</pre></td></tr><tr><td data-num="2"></td><td><pre>db.dropUser<span class="token punctuation">(</span><span class="token string">"user2"</span><span class="token punctuation">)</span></pre></td></tr></table></figure></li><li><p><strong>限制 ip 访问</strong></p><figure class="highlight bash"><figcaption data-lang="bash"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token comment"># 关闭服务（先用默认方法启动数据库：mongo ）：</span></pre></td></tr><tr><td data-num="2"></td><td><pre>use admin            <span class="token comment">#进入 admin 数据库</span></pre></td></tr><tr><td data-num="3"></td><td><pre>db.shutdownServer<span class="token punctuation">(</span><span class="token punctuation">)</span>  <span class="token comment">#关闭服务</span></pre></td></tr><tr><td data-num="4"></td><td><pre><span class="token builtin class-name">exit</span>                 <span class="token comment">#退出数据库</span></pre></td></tr><tr><td data-num="5"></td><td><pre>启动服务（只有本机 IP 可以连接数据库）：</pre></td></tr><tr><td data-num="6"></td><td><pre>mongod --dbpath /data/db --logpath /tmp/mongodb.log --bind_ip <span class="token number">127.0</span>.0.1 --fork</pre></td></tr><tr><td data-num="7"></td><td><pre><span class="token comment"># binf_ip ：限制连接的网络接口，可以设置多个，以逗号隔开。</span></pre></td></tr><tr><td data-num="8"></td><td><pre><span class="token comment"># 限制端口访问 (同样先关数据库服务）</span></pre></td></tr><tr><td data-num="9"></td><td><pre>mongod -port <span class="token number">20000</span> --dbpath /data/db --logpath /tmp/mongodb.log --bind_ip <span class="token number">127.0</span>.0.1 --fork</pre></td></tr><tr><td data-num="10"></td><td><pre><span class="token comment"># 连接数据库</span></pre></td></tr><tr><td data-num="11"></td><td><pre>mongo <span class="token number">127.0</span>.0.1:20000</pre></td></tr></table></figure></li><li><p><strong>Profiling 工具</strong></p><p>优化步骤一般是：</p><ul><li>用慢查询日志（system.profile）找到超过 50ms 的语句；</li><li>然后再通过 .explain () 解析影响行数，分析为什么超过 50ms；</li><li>决定是不是需要添加索引</li></ul><p>Profiling 有两种开启方式，一种是启动服务时配置启动，一种是 mongoshell 中进行实时配置。</p><p>Profiling 级别说明：</p><ul><li>0：关闭，不收集任何数据；</li><li>1：收集慢查询数据，默认是 100 毫秒；</li><li>2：收集所有数据</li></ul><p><strong>全局开启 Profiling:</strong></p><figure class="highlight bash"><figcaption data-lang="bash"></figcaption><table><tr><td data-num="1"></td><td><pre>可以在 mongod 启动时加上以下参数：</pre></td></tr><tr><td data-num="2"></td><td><pre>mongod --profile<span class="token operator">=</span><span class="token number">1</span>  --slowms<span class="token operator">=</span><span class="token number">50</span></pre></td></tr><tr><td data-num="3"></td><td><pre>或在配置文件里添加两行:</pre></td></tr><tr><td data-num="4"></td><td><pre>profile <span class="token operator">=</span> <span class="token number">1</span></pre></td></tr><tr><td data-num="5"></td><td><pre>slowms <span class="token operator">=</span> <span class="token number">50</span></pre></td></tr></table></figure><p><strong>关闭 Profiling 工具：(<strong>只需要将收集慢查询数据的时间设置为 0 就可以关闭</strong>):</strong> <code>db.getProfilingLevel(0)</code></p><p><strong>mongo shell 中启动配置:</strong></p><p>查看状态： <code>db.getProfilingStatue()</code></p><p>查看级别： <code>db.getProfilingLevel()</code></p><p>设置级别： <code>db.setProfilingLevel(1)</code></p><p>设置级别和时间： <code>db.setProfilingLevel(1,50)</code> 时间 50ms</p></li><li><p><strong>只在 linux 有效</strong></p><p>返回所有结果：</p><figure class="highlight bash"><figcaption data-lang="bash"></figcaption><table><tr><td data-num="1"></td><td><pre>db.system.profile.find<span class="token punctuation">(</span><span class="token punctuation">)</span>.pretty<span class="token punctuation">(</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="2"></td><td><pre></pre></td></tr><tr><td data-num="3"></td><td><pre>结果：</pre></td></tr><tr><td data-num="4"></td><td><pre><span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="5"></td><td><pre>			<span class="token string">"op"</span> <span class="token builtin class-name">:</span> <span class="token string">"insert"</span>,         <span class="token comment">#操作类型，有 insert、query、update、remove、getmore、command</span></pre></td></tr><tr><td data-num="6"></td><td><pre>      <span class="token string">"ns"</span> <span class="token builtin class-name">:</span> <span class="token string">"test.items"</span>,     <span class="token comment">#操作的集合</span></pre></td></tr><tr><td data-num="7"></td><td><pre>      <span class="token string">"command"</span> <span class="token builtin class-name">:</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="8"></td><td><pre>              <span class="token string">"insert"</span> <span class="token builtin class-name">:</span> <span class="token string">"items"</span>,</pre></td></tr><tr><td data-num="9"></td><td><pre>              <span class="token string">"ordered"</span> <span class="token builtin class-name">:</span> true,</pre></td></tr><tr><td data-num="10"></td><td><pre>              <span class="token string">"<span class="token variable">$db</span>"</span> <span class="token builtin class-name">:</span> <span class="token string">"test"</span></pre></td></tr><tr><td data-num="11"></td><td><pre>      <span class="token punctuation">&#125;</span>,</pre></td></tr><tr><td data-num="12"></td><td><pre>      <span class="token string">"ninserted"</span> <span class="token builtin class-name">:</span> <span class="token number">1</span>,</pre></td></tr><tr><td data-num="13"></td><td><pre>      <span class="token string">"keysInserted"</span> <span class="token builtin class-name">:</span> <span class="token number">1</span>,</pre></td></tr><tr><td data-num="14"></td><td><pre>      <span class="token string">"numYield"</span><span class="token builtin class-name">:</span> <span class="token number">0</span>,     <span class="token comment">#该操作为了使其他操作完成而放弃的次数。通常来说，当他们需要访问还没有完全读入内存中的数据时，操作将放弃。这使得在 MongoDB 为了放弃操作进行数据读取的同时，还有数据在内存中的其他操作可以完成</span></pre></td></tr><tr><td data-num="15"></td><td><pre>      <span class="token string">"locks"</span><span class="token builtin class-name">:</span> <span class="token punctuation">&#123;</span>         <span class="token comment">#锁信息，R：全局读锁；W：全局写锁；r：特定数据库的读锁；w：特定数据库的写锁</span></pre></td></tr><tr><td data-num="16"></td><td><pre>              <span class="token string">"Global"</span> <span class="token builtin class-name">:</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="17"></td><td><pre>                      <span class="token string">"acquireCount"</span> <span class="token builtin class-name">:</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="18"></td><td><pre>                              <span class="token string">"r"</span> <span class="token builtin class-name">:</span> NumberLong<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>,</pre></td></tr><tr><td data-num="19"></td><td><pre>                              <span class="token string">"w"</span> <span class="token builtin class-name">:</span> NumberLong<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="20"></td><td><pre>                      <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="21"></td><td><pre>              <span class="token punctuation">&#125;</span>,</pre></td></tr><tr><td data-num="22"></td><td><pre>              <span class="token string">"Database"</span> <span class="token builtin class-name">:</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="23"></td><td><pre>                      <span class="token string">"acquireCount"</span> <span class="token builtin class-name">:</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="24"></td><td><pre>                              <span class="token string">"w"</span> <span class="token builtin class-name">:</span> NumberLong<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="25"></td><td><pre>                      <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="26"></td><td><pre>              <span class="token punctuation">&#125;</span>,</pre></td></tr><tr><td data-num="27"></td><td><pre>              <span class="token string">"Collection"</span> <span class="token builtin class-name">:</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="28"></td><td><pre>                      <span class="token string">"acquireCount"</span> <span class="token builtin class-name">:</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="29"></td><td><pre>                              <span class="token string">"w"</span> <span class="token builtin class-name">:</span> NumberLong<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="30"></td><td><pre>                      <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="31"></td><td><pre>              <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="32"></td><td><pre>      <span class="token punctuation">&#125;</span>,</pre></td></tr><tr><td data-num="33"></td><td><pre>      <span class="token string">"responseLength"</span> <span class="token builtin class-name">:</span> <span class="token number">45</span>,     <span class="token comment">#返回字节长度，如果这个数字很大，考虑值返回所需字段</span></pre></td></tr><tr><td data-num="34"></td><td><pre>      <span class="token string">"protocol"</span> <span class="token builtin class-name">:</span> <span class="token string">"op_msg"</span>,</pre></td></tr><tr><td data-num="35"></td><td><pre>      <span class="token string">"millis"</span> <span class="token builtin class-name">:</span> <span class="token number">60</span>,     <span class="token comment">#消耗的时间（毫秒）</span></pre></td></tr><tr><td data-num="36"></td><td><pre>      <span class="token string">"ts"</span> <span class="token builtin class-name">:</span> ISODate<span class="token punctuation">(</span><span class="token string">"2018-12-07T08:19:11.997Z"</span><span class="token punctuation">)</span>,     <span class="token comment">#该命令在何时执行</span></pre></td></tr><tr><td data-num="37"></td><td><pre>      <span class="token string">"client"</span> <span class="token builtin class-name">:</span> <span class="token string">"127.0.0.1"</span>,     <span class="token comment">#链接 ip 或则主机</span></pre></td></tr><tr><td data-num="38"></td><td><pre>      <span class="token string">"appName"</span> <span class="token builtin class-name">:</span> <span class="token string">"MongoDB Shell"</span>,</pre></td></tr><tr><td data-num="39"></td><td><pre>      <span class="token string">"allUsers"</span> <span class="token builtin class-name">:</span> <span class="token punctuation">[</span> <span class="token punctuation">]</span>,</pre></td></tr><tr><td data-num="40"></td><td><pre>      <span class="token string">"user"</span> <span class="token builtin class-name">:</span> <span class="token string">""</span></pre></td></tr><tr><td data-num="41"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr></table></figure><p>profile 部分字段解释：</p><ul><li>op ：操作类型；</li><li>ns ：被查的集合；</li><li>commond ：命令的内容；</li><li>docsExamined ：扫描文档数；</li><li>nreturned ：返回记录数；</li><li>millis ：耗时时间，单位毫秒；</li><li>ts ：命令执行时间；</li><li>responseLength ：返回内容长度。</li><li><strong>常用的慢日志查询命令</strong><ul><li><p>返回最近的 10 条记录：</p><figure class="highlight bash"><figcaption data-lang="bash"></figcaption><table><tr><td data-num="1"></td><td><pre>db.system.profile.find<span class="token punctuation">(</span><span class="token punctuation">)</span>.limit<span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">)</span>.sort<span class="token punctuation">(</span><span class="token punctuation">&#123;</span> ts <span class="token builtin class-name">:</span> -1 <span class="token punctuation">&#125;</span><span class="token punctuation">)</span>.pretty<span class="token punctuation">(</span><span class="token punctuation">)</span></pre></td></tr></table></figure></li><li><p>返回所有的操作，除 command 类型的：</p><figure class="highlight bash"><figcaption data-lang="bash"></figcaption><table><tr><td data-num="1"></td><td><pre>db.system.profile.find<span class="token punctuation">(</span> <span class="token punctuation">&#123;</span> op: <span class="token punctuation">&#123;</span> <span class="token variable">$ne</span> <span class="token builtin class-name">:</span> <span class="token string">'command'</span><span class="token punctuation">&#125;</span> <span class="token punctuation">&#125;</span><span class="token punctuation">)</span>.pretty<span class="token punctuation">(</span><span class="token punctuation">)</span></pre></td></tr></table></figure></li><li><p>返回特定集合：</p><figure class="highlight bash"><figcaption data-lang="bash"></figcaption><table><tr><td data-num="1"></td><td><pre>db.system.profile.find<span class="token punctuation">(</span> <span class="token punctuation">&#123;</span> ns <span class="token builtin class-name">:</span> <span class="token string">'test.items'</span> <span class="token punctuation">&#125;</span> <span class="token punctuation">)</span>.pretty<span class="token punctuation">(</span><span class="token punctuation">)</span></pre></td></tr></table></figure></li><li><p>返回大于 5 毫秒慢的操作：</p><figure class="highlight bash"><figcaption data-lang="bash"></figcaption><table><tr><td data-num="1"></td><td><pre>db.system.profile.find<span class="token punctuation">(</span><span class="token punctuation">&#123;</span> millis <span class="token builtin class-name">:</span> <span class="token punctuation">&#123;</span> <span class="token variable">$gt</span> <span class="token builtin class-name">:</span> <span class="token number">5</span> <span class="token punctuation">&#125;</span> <span class="token punctuation">&#125;</span> <span class="token punctuation">)</span>.pretty<span class="token punctuation">(</span><span class="token punctuation">)</span></pre></td></tr></table></figure></li><li><p>从一个特定的时间范围内返回信息：</p><figure class="highlight bash"><figcaption data-lang="bash"></figcaption><table><tr><td data-num="1"></td><td><pre>db.system.profile.find<span class="token punctuation">(</span>                    </pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token punctuation">&#123;</span>                     </pre></td></tr><tr><td data-num="3"></td><td><pre>	ts <span class="token builtin class-name">:</span> <span class="token punctuation">&#123;</span>                           </pre></td></tr><tr><td data-num="4"></td><td><pre>		<span class="token variable">$gt</span> <span class="token builtin class-name">:</span> new ISODate<span class="token punctuation">(</span><span class="token string">"2018-12-09T08:00:00Z"</span><span class="token punctuation">)</span>,                          </pre></td></tr><tr><td data-num="5"></td><td><pre>		<span class="token variable">$lt</span> <span class="token builtin class-name">:</span> new ISODate<span class="token punctuation">(</span><span class="token string">"2018-12-10T03:40:00Z"</span><span class="token punctuation">)</span>                          </pre></td></tr><tr><td data-num="6"></td><td><pre>	<span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="7"></td><td><pre><span class="token punctuation">&#125;</span><span class="token punctuation">)</span>.pretty<span class="token punctuation">(</span><span class="token punctuation">)</span></pre></td></tr></table></figure></li><li><p>特定时间，限制用户，按照消耗时间排序：</p><figure class="highlight bash"><figcaption data-lang="bash"></figcaption><table><tr><td data-num="1"></td><td><pre>db.system.profile.find<span class="token punctuation">(</span>                    </pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token punctuation">&#123;</span>                      </pre></td></tr><tr><td data-num="3"></td><td><pre>	ts <span class="token builtin class-name">:</span> <span class="token punctuation">&#123;</span>                            </pre></td></tr><tr><td data-num="4"></td><td><pre>		<span class="token variable">$gt</span> <span class="token builtin class-name">:</span> new ISODate<span class="token punctuation">(</span><span class="token string">"2018-12-09T08:00:00Z"</span><span class="token punctuation">)</span>,                            </pre></td></tr><tr><td data-num="5"></td><td><pre>		<span class="token variable">$lt</span> <span class="token builtin class-name">:</span> new ISODate<span class="token punctuation">(</span><span class="token string">"2018-12-10T03:40:00Z"</span><span class="token punctuation">)</span>                           </pre></td></tr><tr><td data-num="6"></td><td><pre>	<span class="token punctuation">&#125;</span>                    </pre></td></tr><tr><td data-num="7"></td><td><pre><span class="token punctuation">&#125;</span>,                    </pre></td></tr><tr><td data-num="8"></td><td><pre><span class="token punctuation">&#123;</span> user <span class="token builtin class-name">:</span> <span class="token number">0</span> <span class="token punctuation">&#125;</span>                   </pre></td></tr><tr><td data-num="9"></td><td><pre><span class="token punctuation">)</span>.sort<span class="token punctuation">(</span> <span class="token punctuation">&#123;</span> millis <span class="token builtin class-name">:</span> -1 <span class="token punctuation">&#125;</span> <span class="token punctuation">)</span>.pretty<span class="token punctuation">(</span><span class="token punctuation">)</span></pre></td></tr></table></figure></li><li><p>查看最新的 Profile 记录：</p><figure class="highlight bash"><figcaption data-lang="bash"></figcaption><table><tr><td data-num="1"></td><td><pre>db.system.profile.find<span class="token punctuation">(</span><span class="token punctuation">)</span>.sort<span class="token punctuation">(</span><span class="token punctuation">&#123;</span><span class="token variable">$natural</span>:-1<span class="token punctuation">&#125;</span><span class="token punctuation">)</span>.limit<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>.pretty<span class="token punctuation">(</span><span class="token punctuation">)</span></pre></td></tr></table></figure></li><li><p>显示 5 个最近的事件 (这个 Windows 有反应但是数据不对)：</p><figure class="highlight bash"><figcaption data-lang="bash"></figcaption><table><tr><td data-num="1"></td><td><pre>show profile</pre></td></tr></table></figure></li></ul></li></ul></li><li><h2 id="主从复制"><a class="anchor" href="#主从复制">#</a> <strong>主从复制</strong></h2><p>配置文件：</p><figure class="highlight bash"><figcaption data-lang="bash"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token comment"># 8888.conf</span></pre></td></tr><tr><td data-num="2"></td><td><pre>dbpath <span class="token operator">=</span>                <span class="token comment">#主数据库地址</span></pre></td></tr><tr><td data-num="3"></td><td><pre>port <span class="token operator">=</span> <span class="token number">8888</span>             <span class="token comment">#主数据库端口号</span></pre></td></tr><tr><td data-num="4"></td><td><pre>bind_ip <span class="token operator">=</span> <span class="token number">127.0</span>.0.1    <span class="token comment">#主数据库所在服务器</span></pre></td></tr><tr><td data-num="5"></td><td><pre>master <span class="token operator">=</span> <span class="token boolean">true</span>           <span class="token comment">#确定我是主服务器</span></pre></td></tr></table></figure><figure class="highlight bash"><figcaption data-lang="bash"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token comment"># 7777.conf</span></pre></td></tr><tr><td data-num="2"></td><td><pre>dbpath <span class="token operator">=</span>                    <span class="token comment">#从数据库地址</span></pre></td></tr><tr><td data-num="3"></td><td><pre>port <span class="token operator">=</span> <span class="token number">7777</span>                 <span class="token comment">#从数据库端口号</span></pre></td></tr><tr><td data-num="4"></td><td><pre>bind_ip <span class="token operator">=</span> <span class="token number">127.0</span>.0.1         <span class="token comment">#从数据库所在服务器</span></pre></td></tr><tr><td data-num="5"></td><td><pre><span class="token builtin class-name">source</span> <span class="token operator">=</span> <span class="token number">127.0</span>.0.1:8888     <span class="token comment">#确定我数据库端口  这个配置项 (source) 可以用 shell 动态添加</span></pre></td></tr><tr><td data-num="6"></td><td><pre>slave <span class="token operator">=</span> <span class="token boolean">true</span>                <span class="token comment">#确定自己是从服务器</span></pre></td></tr></table></figure><figure class="highlight bash"><figcaption data-lang="bash"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token comment">#启动</span></pre></td></tr><tr><td data-num="2"></td><td><pre>mongod --config <span class="token number">7777</span>.conf</pre></td></tr><tr><td data-num="3"></td><td><pre>mongod --config <span class="token number">8888</span>.conf</pre></td></tr></table></figure><p>主从复制的其他设置项</p><figure class="highlight bash"><figcaption data-lang="bash"></figcaption><table><tr><td data-num="1"></td><td><pre>--only        <span class="token comment"># 从节点 > 指定复制某个数据库默认是复制全部数据库</span></pre></td></tr><tr><td data-num="2"></td><td><pre>--slavedelay  <span class="token comment"># 从节点 > 设置主数据库同步数据的延迟 (单位是秒)</span></pre></td></tr><tr><td data-num="3"></td><td><pre>--fastsync    <span class="token comment"># 从节点 > 以主数据库的节点快照为节点启动从数据库</span></pre></td></tr><tr><td data-num="4"></td><td><pre>--autoresync  <span class="token comment"># 从节点 > 如果不同步则从新 同步数据库</span></pre></td></tr><tr><td data-num="5"></td><td><pre>--oplogSize   <span class="token comment"># 主节点 > 设置 oplog 的大小 (主节点操作记录存储到 local 的 oplog 中)</span></pre></td></tr></table></figure><figure class="highlight bash"><figcaption data-lang="bash"></figcaption><table><tr><td data-num="1"></td><td><pre>**从节点**中关于主节点的信息全部存到local的sources的集合中</pre></td></tr><tr><td data-num="2"></td><td><pre>只要对集合进行操作就可以动态操作主从关系</pre></td></tr><tr><td data-num="3"></td><td><pre>use <span class="token builtin class-name">local</span></pre></td></tr><tr><td data-num="4"></td><td><pre>挂接主节点操作之前只留下从数据库服务</pre></td></tr><tr><td data-num="5"></td><td><pre>db.sources.insert<span class="token punctuation">(</span><span class="token punctuation">&#123;</span><span class="token string">"host"</span><span class="token builtin class-name">:</span><span class="token string">"127.0.0.1:8888"</span><span class="token punctuation">&#125;</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="6"></td><td><pre>删除已经挂接的主节点操作之前只留下从数据库服务</pre></td></tr><tr><td data-num="7"></td><td><pre>db.sources.remove<span class="token punctuation">(</span><span class="token punctuation">&#123;</span><span class="token string">"host"</span><span class="token builtin class-name">:</span><span class="token string">"127.0.0.1:8888"</span><span class="token punctuation">&#125;</span><span class="token punctuation">)</span></pre></td></tr></table></figure></li><li><h2 id="副本集的搭建linux"><a class="anchor" href="#副本集的搭建linux">#</a> <strong>副本集的搭建（Linux）</strong></h2><p>非配置文件：<span class="exturl" data-url="aHR0cHM6Ly93d3cucnVub29iLmNvbS9tb25nb2RiL21vbmdvZGItcmVwbGljYXRpb24uaHRtbA==">MongoDB 复制 (副本集) | 菜鸟教程 (runoob.com)</span></p><p>相关文件配置 (可将其配置到对应的数据库地址中，注释的地方修改后就是一个新的副本)：</p><figure class="highlight bash"><figcaption data-lang="bash"></figcaption><table><tr><td data-num="1"></td><td><pre>systemLog:</pre></td></tr><tr><td data-num="2"></td><td><pre>    destination: <span class="token function">file</span></pre></td></tr><tr><td data-num="3"></td><td><pre>    path: /data/db1/mongod.log <span class="token comment"># log path</span></pre></td></tr><tr><td data-num="4"></td><td><pre>    logAppend: <span class="token boolean">true</span></pre></td></tr><tr><td data-num="5"></td><td><pre>storage <span class="token builtin class-name">:</span></pre></td></tr><tr><td data-num="6"></td><td><pre>    dbPath: /data/db1          <span class="token comment"># data directory</span></pre></td></tr><tr><td data-num="7"></td><td><pre>net <span class="token builtin class-name">:</span></pre></td></tr><tr><td data-num="8"></td><td><pre>    bindIp: <span class="token number">0.0</span>.0.0</pre></td></tr><tr><td data-num="9"></td><td><pre>    port: <span class="token number">28017</span>                <span class="token comment"># port</span></pre></td></tr><tr><td data-num="10"></td><td><pre>replication:</pre></td></tr><tr><td data-num="11"></td><td><pre>    replSetName: rs0</pre></td></tr><tr><td data-num="12"></td><td><pre>processManagement:</pre></td></tr><tr><td data-num="13"></td><td><pre>    fork: <span class="token boolean">true</span></pre></td></tr></table></figure><figure class="highlight bash"><figcaption data-lang="bash"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token comment"># 进入对应环境</span></pre></td></tr><tr><td data-num="2"></td><td><pre>mongo localhost:28018</pre></td></tr><tr><td data-num="3"></td><td><pre><span class="token comment"># 复制集的搭建</span></pre></td></tr><tr><td data-num="4"></td><td><pre>rs.initiate<span class="token punctuation">(</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="5"></td><td><pre><span class="token comment">#  出现：rs0:OTHER > 或 rs0:SECONDARY> 表示进入复制集 在按回车进入 rs0:PRIMARY></span></pre></td></tr><tr><td data-num="6"></td><td><pre><span class="token comment"># 查看状态</span></pre></td></tr><tr><td data-num="7"></td><td><pre>rs.status<span class="token punctuation">(</span><span class="token punctuation">)</span> </pre></td></tr><tr><td data-num="8"></td><td><pre><span class="token comment"># 添加副本节点</span></pre></td></tr><tr><td data-num="9"></td><td><pre>rs.add<span class="token punctuation">(</span><span class="token string">"主机名:28018"</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="10"></td><td><pre><span class="token comment"># 添加仲裁节点</span></pre></td></tr><tr><td data-num="11"></td><td><pre>rs.addArb<span class="token punctuation">(</span><span class="token string">"180.76.159.126:27019"</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="12"></td><td><pre><span class="token comment"># 一般情况副本是不允许查询的所以需要查询要开启开启从库查询功能</span></pre></td></tr><tr><td data-num="13"></td><td><pre>rs.slaveOk<span class="token punctuation">(</span><span class="token punctuation">)</span> 或 rs.slaveOk<span class="token punctuation">(</span>true<span class="token punctuation">)</span>              <span class="token comment"># 在从服务器中使用命令 或</span></pre></td></tr><tr><td data-num="14"></td><td><pre>db.getMongo<span class="token punctuation">(</span><span class="token punctuation">)</span>.setSlaveOK<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token comment"># 在主服务器使用命令</span></pre></td></tr><tr><td data-num="15"></td><td><pre><span class="token comment"># 若取消读权限则</span></pre></td></tr><tr><td data-num="16"></td><td><pre>rs.slaveOk<span class="token punctuation">(</span>false<span class="token punctuation">)</span></pre></td></tr></table></figure></li><li><h2 id="副本集的搭建windows"><a class="anchor" href="#副本集的搭建windows">#</a> <strong>副本集的搭建（Windows）</strong></h2><p>主节点出现故障，其余服务器会被推选出主节点，出现故障的服务器修好后，自动变成副节点</p><figure class="highlight bash"><figcaption data-lang="bash"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token comment"># 三个服务形成闭环</span></pre></td></tr><tr><td data-num="2"></td><td><pre>dbpath <span class="token operator">=</span> D:<span class="token punctuation">\</span>sortware<span class="token punctuation">\</span>mongod<span class="token punctuation">\</span>02<span class="token punctuation">\</span>B</pre></td></tr><tr><td data-num="3"></td><td><pre><span class="token assign-left variable">port</span><span class="token operator">=</span> <span class="token number">2222</span></pre></td></tr><tr><td data-num="4"></td><td><pre><span class="token assign-left variable">bind_ip</span><span class="token operator">=</span> <span class="token number">127.0</span>.0.1</pre></td></tr><tr><td data-num="5"></td><td><pre>replSet <span class="token operator">=</span> child/127.0.0.1:3333</pre></td></tr><tr><td data-num="6"></td><td><pre></pre></td></tr><tr><td data-num="7"></td><td><pre>dbpath <span class="token operator">=</span> D:<span class="token punctuation">\</span>sortware<span class="token punctuation">\</span>mongod<span class="token punctuation">\</span>02<span class="token punctuation">\</span>C</pre></td></tr><tr><td data-num="8"></td><td><pre><span class="token assign-left variable">port</span><span class="token operator">=</span> <span class="token number">3333</span></pre></td></tr><tr><td data-num="9"></td><td><pre><span class="token assign-left variable">bind_ip</span><span class="token operator">=</span> <span class="token number">127.0</span>.0.1</pre></td></tr><tr><td data-num="10"></td><td><pre>replSet <span class="token operator">=</span> child/127.0.0.1:1111</pre></td></tr><tr><td data-num="11"></td><td><pre></pre></td></tr><tr><td data-num="12"></td><td><pre>dbpath <span class="token operator">=</span> D:<span class="token punctuation">\</span>sortware<span class="token punctuation">\</span>mongod<span class="token punctuation">\</span>02<span class="token punctuation">\</span>A</pre></td></tr><tr><td data-num="13"></td><td><pre><span class="token assign-left variable">port</span><span class="token operator">=</span> <span class="token number">1111</span> <span class="token comment">#端口</span></pre></td></tr><tr><td data-num="14"></td><td><pre>bind_ip <span class="token operator">=</span> <span class="token number">127.0</span>.0.1 <span class="token comment">#服务地址</span></pre></td></tr><tr><td data-num="15"></td><td><pre>replSet <span class="token operator">=</span> child/127.0.0.1:2222<span class="token comment">#设定同伴</span></pre></td></tr><tr><td data-num="16"></td><td><pre></pre></td></tr><tr><td data-num="17"></td><td><pre><span class="token comment"># 开启服务</span></pre></td></tr><tr><td data-num="18"></td><td><pre>mongod --config A.conf</pre></td></tr><tr><td data-num="19"></td><td><pre>mongod --config B.conf</pre></td></tr><tr><td data-num="20"></td><td><pre>mongod --config C.conf</pre></td></tr><tr><td data-num="21"></td><td><pre><span class="token comment"># 启动 shell</span></pre></td></tr><tr><td data-num="22"></td><td><pre>mongo <span class="token number">127.0</span>.0.1:1111</pre></td></tr></table></figure><figure class="highlight bash"><figcaption data-lang="bash"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token comment"># 2. 初始化副本集</span></pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token comment"># 注：备份点不能进行查询操作，只有活跃点 (shell 会有 PRIMARY>) 可以进行查询操作，所以应在活跃点进行初始化</span></pre></td></tr><tr><td data-num="3"></td><td><pre>use admin</pre></td></tr><tr><td data-num="4"></td><td><pre>db.runCommand<span class="token punctuation">(</span><span class="token punctuation">&#123;</span><span class="token string">"replSetInitiate"</span><span class="token builtin class-name">:</span></pre></td></tr><tr><td data-num="5"></td><td><pre><span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="6"></td><td><pre>    <span class="token string">"id"</span><span class="token builtin class-name">:</span><span class="token string">'child'</span>,  <span class="token comment"># 与上面 child 对应</span></pre></td></tr><tr><td data-num="7"></td><td><pre>    <span class="token string">"members"</span>:<span class="token punctuation">[</span></pre></td></tr><tr><td data-num="8"></td><td><pre>        <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="9"></td><td><pre>            <span class="token string">"_id"</span>:1,</pre></td></tr><tr><td data-num="10"></td><td><pre>            <span class="token string">"hostl"</span><span class="token builtin class-name">:</span><span class="token string">"127.0.0.1:1111"</span></pre></td></tr><tr><td data-num="11"></td><td><pre>        <span class="token punctuation">&#125;</span>,</pre></td></tr><tr><td data-num="12"></td><td><pre>        <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="13"></td><td><pre>            <span class="token string">"_id"</span>:2,</pre></td></tr><tr><td data-num="14"></td><td><pre>            <span class="token string">"host"</span><span class="token builtin class-name">:</span><span class="token string">"127.0.0.1:2222"</span></pre></td></tr><tr><td data-num="15"></td><td><pre>        <span class="token punctuation">&#125;</span>,</pre></td></tr><tr><td data-num="16"></td><td><pre>        <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="17"></td><td><pre>            <span class="token string">"_id"</span>:3,</pre></td></tr><tr><td data-num="18"></td><td><pre>            <span class="token string">"host"</span><span class="token builtin class-name">:</span><span class="token string">"127.0.0.1:3333"</span></pre></td></tr><tr><td data-num="19"></td><td><pre>        <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="20"></td><td><pre>    <span class="token punctuation">]</span></pre></td></tr><tr><td data-num="21"></td><td><pre><span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="22"></td><td><pre><span class="token comment"># 2. 查看副本集状态</span></pre></td></tr><tr><td data-num="23"></td><td><pre>rs.status<span class="token punctuation">(</span><span class="token punctuation">)</span></pre></td></tr></table></figure><figure class="highlight bash"><figcaption data-lang="bash"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token comment"># 3. 节点和初始化高级参数</span></pre></td></tr><tr><td data-num="2"></td><td><pre>standard    常规节点:参与投票有可能成为活跃节点</pre></td></tr><tr><td data-num="3"></td><td><pre>passive     副本节点:参与投票但是不能成为活跃节点</pre></td></tr><tr><td data-num="4"></td><td><pre>arbiter     仲裁节点:只是参与投票不复制节点也不能成为活跃节点</pre></td></tr><tr><td data-num="5"></td><td><pre><span class="token comment"># 4. 高级参数</span></pre></td></tr><tr><td data-num="6"></td><td><pre>Priority <span class="token number">0</span>到1000之间,0代表是副本节点,1到1000是常规节点</pre></td></tr><tr><td data-num="7"></td><td><pre>arbiterOnly :true仲裁节点</pre></td></tr><tr><td data-num="8"></td><td><pre>用法</pre></td></tr><tr><td data-num="9"></td><td><pre>members:<span class="token punctuation">[</span><span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="10"></td><td><pre>    <span class="token string">"_id"</span>:1,</pre></td></tr><tr><td data-num="11"></td><td><pre>    <span class="token string">"host"</span><span class="token builtin class-name">:</span><span class="token string">"127.0.0.1:1111"</span>,</pre></td></tr><tr><td data-num="12"></td><td><pre>    arbiterOnly <span class="token builtin class-name">:</span> <span class="token boolean">true</span></pre></td></tr><tr><td data-num="13"></td><td><pre><span class="token punctuation">&#125;</span><span class="token punctuation">]</span></pre></td></tr><tr><td data-num="14"></td><td><pre><span class="token comment"># 5. 优先级相同时候仲裁组建的规则</span></pre></td></tr><tr><td data-num="15"></td><td><pre><span class="token comment"># 会选更新时间最早的数据库</span></pre></td></tr><tr><td data-num="16"></td><td><pre><span class="token comment"># 6. 读写分离操作 > 扩展读</span></pre></td></tr><tr><td data-num="17"></td><td><pre><span class="token comment">#     6.1 一般情况下作为副本的节点是不能进行数据库读操作的</span></pre></td></tr><tr><td data-num="18"></td><td><pre><span class="token comment">#         但是在读取密集型的系统中读写分离是十分必要的</span></pre></td></tr><tr><td data-num="19"></td><td><pre><span class="token comment">#     6.2 设直读写分离</span></pre></td></tr><tr><td data-num="20"></td><td><pre><span class="token comment">#         slaveOkay: true</span></pre></td></tr><tr><td data-num="21"></td><td><pre><span class="token comment">#         很遗憾他在 shell 中无法掩饰，，这个特性是被与到 mongoDB 的</span></pre></td></tr><tr><td data-num="22"></td><td><pre><span class="token comment">#         驱动程序中的，在 java 和 node 等其他语言中可以完成</span></pre></td></tr><tr><td data-num="23"></td><td><pre><span class="token comment"># 7.oplog</span></pre></td></tr><tr><td data-num="24"></td><td><pre><span class="token comment">#     他是被存储在本地数据库 local 中的，他的每一个文档保证这一 个节点操作</span></pre></td></tr><tr><td data-num="25"></td><td><pre><span class="token comment">#     如果想故障恢复可以更彻底 oplog 可已经尽量设置大一些用来保存更 多的操作</span></pre></td></tr><tr><td data-num="26"></td><td><pre><span class="token comment">#     信息</span></pre></td></tr><tr><td data-num="27"></td><td><pre><span class="token comment">#     改变 oplog 大小</span></pre></td></tr><tr><td data-num="28"></td><td><pre><span class="token comment">#     主库 --master --oplogSize size</span></pre></td></tr></table></figure></li><li><h2 id="头歌上的副本搭建"><a class="anchor" href="#头歌上的副本搭建">#</a> <strong>头歌上的副本搭建</strong></h2><figure class="highlight bash"><figcaption data-lang="bash"></figcaption><table><tr><td data-num="1"></td><td><pre>mongod1.conf 内容如下：同理配三个并执行</pre></td></tr><tr><td data-num="2"></td><td><pre></pre></td></tr><tr><td data-num="3"></td><td><pre><span class="token assign-left variable">port</span><span class="token operator">=</span><span class="token number">27018</span>     <span class="token comment">#配置端口号</span></pre></td></tr><tr><td data-num="4"></td><td><pre><span class="token assign-left variable">dbpath</span><span class="token operator">=</span>/data/db1     <span class="token comment">#配置数据存放的位置</span></pre></td></tr><tr><td data-num="5"></td><td><pre><span class="token assign-left variable">logpath</span><span class="token operator">=</span>/logs/mongo/mongod1.log     <span class="token comment">#配置日志存放的位置</span></pre></td></tr><tr><td data-num="6"></td><td><pre><span class="token assign-left variable">logappend</span><span class="token operator">=</span>true     <span class="token comment">#日志使用追加的方式</span></pre></td></tr><tr><td data-num="7"></td><td><pre><span class="token assign-left variable">fork</span><span class="token operator">=</span>true     <span class="token comment">#设置在后台运行</span></pre></td></tr><tr><td data-num="8"></td><td><pre><span class="token assign-left variable">replSet</span><span class="token operator">=</span>YOURMONGO     <span class="token comment">#配置复制集名称，该名称要在所有的服务器一致</span></pre></td></tr><tr><td data-num="9"></td><td><pre></pre></td></tr><tr><td data-num="10"></td><td><pre>执行： mongod -f /etc/mongod/mongod1.conf</pre></td></tr></table></figure><p>配主节点并配置仲裁：</p><figure class="highlight bash"><figcaption data-lang="bash"></figcaption><table><tr><td data-num="1"></td><td><pre>config <span class="token operator">=</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="2"></td><td><pre>  _id:<span class="token string">"YOURMONGO"</span>,</pre></td></tr><tr><td data-num="3"></td><td><pre>  members:<span class="token punctuation">[</span></pre></td></tr><tr><td data-num="4"></td><td><pre>      <span class="token punctuation">&#123;</span>_id:0,host:<span class="token string">'127.0.0.1:27018'</span><span class="token punctuation">&#125;</span>,</pre></td></tr><tr><td data-num="5"></td><td><pre>      <span class="token punctuation">&#123;</span>_id:1,host:<span class="token string">'127.0.0.1:27019'</span>,arbiterOnly:true<span class="token punctuation">&#125;</span>,</pre></td></tr><tr><td data-num="6"></td><td><pre>      <span class="token punctuation">&#123;</span>_id:2,host:<span class="token string">'127.0.0.1:27020'</span><span class="token punctuation">&#125;</span>,</pre></td></tr><tr><td data-num="7"></td><td><pre>  <span class="token punctuation">]</span></pre></td></tr><tr><td data-num="8"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="9"></td><td><pre>rs.initiate<span class="token punctuation">(</span>config<span class="token punctuation">)</span></pre></td></tr></table></figure><p><strong>切换 Primary 节点到指定的节点</strong></p><figure class="highlight bash"><figcaption data-lang="bash"></figcaption><table><tr><td data-num="1"></td><td><pre>mongo --port <span class="token number">27018</span></pre></td></tr><tr><td data-num="2"></td><td><pre>rs.conf<span class="token punctuation">(</span><span class="token punctuation">)</span>     <span class="token comment">#查看配置</span></pre></td></tr><tr><td data-num="3"></td><td><pre>rs.status<span class="token punctuation">(</span><span class="token punctuation">)</span>   <span class="token comment">#查看状态</span></pre></td></tr><tr><td data-num="4"></td><td><pre></pre></td></tr><tr><td data-num="5"></td><td><pre><span class="token comment"># 其中 priority : 是优先级，默认为 1，优先级 0 为被动节点，不能成为活跃节点。优先级不为 0 则按照由大到小选出活跃节点</span></pre></td></tr><tr><td data-num="6"></td><td><pre><span class="token comment"># 因为默认的都是 1，所以只需要把给定的服务器的 priority 加到最大即可。让 27020 成为主节点，操作如下</span></pre></td></tr><tr><td data-num="7"></td><td><pre><span class="token assign-left variable">cfg</span><span class="token operator">=</span>rs.conf<span class="token punctuation">(</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="8"></td><td><pre>cfg.members<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span>.priority<span class="token operator">=</span><span class="token number">2</span>     <span class="token comment">#修改 priority,members [2] 即对应 27020 端口</span></pre></td></tr><tr><td data-num="9"></td><td><pre>rs.reconfig<span class="token punctuation">(</span>cfg<span class="token punctuation">)</span>     <span class="token comment">#重新加载配置文件，强制了副本集进行一次选举，优先级高的成为 Primary。在这之间整个集群的所有节点都是 secondary</span></pre></td></tr><tr><td data-num="10"></td><td><pre>rs.status<span class="token punctuation">(</span><span class="token punctuation">)</span></pre></td></tr></table></figure></li><li><h2 id="头歌的分片集搭建"><a class="anchor" href="#头歌的分片集搭建">#</a> <strong>头歌的分片集搭建</strong></h2><p><strong>配置文件设置</strong></p><figure class="highlight bash"><figcaption data-lang="bash"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token function">mkdir</span> -p /data/shard1/db</pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token function">mkdir</span> -p /logs/shard1/log</pre></td></tr><tr><td data-num="3"></td><td><pre><span class="token function">mkdir</span> -p /data/shard2/db</pre></td></tr><tr><td data-num="4"></td><td><pre><span class="token function">mkdir</span> -p /logs/shard2/log</pre></td></tr><tr><td data-num="5"></td><td><pre><span class="token function">mkdir</span> -p /data/shard3/db</pre></td></tr><tr><td data-num="6"></td><td><pre><span class="token function">mkdir</span> -p /logs/shard3/log</pre></td></tr><tr><td data-num="7"></td><td><pre><span class="token function">mkdir</span> -p /data/config/db</pre></td></tr><tr><td data-num="8"></td><td><pre><span class="token function">mkdir</span> -p /logs/config/log</pre></td></tr><tr><td data-num="9"></td><td><pre><span class="token function">mkdir</span> -p /logs/mongs/log</pre></td></tr></table></figure><p>配置文件 (新建在 /etc/mongo 目录下):(其中 shardsvr 是用来开启分片的。)</p><figure class="highlight bash"><figcaption data-lang="bash"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token assign-left variable">dbpath</span><span class="token operator">=</span>/data/shard1/db</pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token assign-left variable">logpath</span><span class="token operator">=</span>/logs/shard1/log/mongodb.log</pre></td></tr><tr><td data-num="3"></td><td><pre><span class="token assign-left variable">port</span><span class="token operator">=</span><span class="token number">10001</span></pre></td></tr><tr><td data-num="4"></td><td><pre><span class="token assign-left variable">shardsvr</span><span class="token operator">=</span>true</pre></td></tr><tr><td data-num="5"></td><td><pre><span class="token assign-left variable">fork</span><span class="token operator">=</span>true</pre></td></tr><tr><td data-num="6"></td><td><pre></pre></td></tr><tr><td data-num="7"></td><td><pre>之后配三个与副本集群同理</pre></td></tr><tr><td data-num="8"></td><td><pre>mongod -f /etc/mongo/mongod1.conf</pre></td></tr></table></figure><p><strong>config 节点</strong></p><figure class="highlight bash"><figcaption data-lang="bash"></figcaption><table><tr><td data-num="1"></td><td><pre>mongod --dbpath /data/config/db --logpath /logs/config/log/mongodb.log --port <span class="token number">10004</span> --configsvr --replSet cs --fork</pre></td></tr></table></figure><p>连接 route 节点： <code>mongo localhost:10004</code></p><p>输入以下命令：</p><figure class="highlight bash"><figcaption data-lang="bash"></figcaption><table><tr><td data-num="1"></td><td><pre>use admin</pre></td></tr><tr><td data-num="2"></td><td><pre>cfg <span class="token operator">=</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="3"></td><td><pre>  _id:<span class="token string">'cs'</span>,</pre></td></tr><tr><td data-num="4"></td><td><pre>  configsvr:true,</pre></td></tr><tr><td data-num="5"></td><td><pre>  members:<span class="token punctuation">[</span></pre></td></tr><tr><td data-num="6"></td><td><pre>      <span class="token punctuation">&#123;</span>_id:0,host:<span class="token string">'localhost:10004'</span><span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="7"></td><td><pre>   <span class="token punctuation">]</span></pre></td></tr><tr><td data-num="8"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="9"></td><td><pre>rs.initiate<span class="token punctuation">(</span>cfg<span class="token punctuation">)</span></pre></td></tr></table></figure><p><strong>route 节点</strong></p><figure class="highlight bash"><figcaption data-lang="bash"></figcaption><table><tr><td data-num="1"></td><td><pre>mongos --configdb cs/localhost:10004 --logpath /logs/mongs/log/mongodb.log --port <span class="token number">10005</span> --fork</pre></td></tr></table></figure><p>连接上 route 节点： <code>mongo localhost:10005</code></p><p>添加分片：</p><figure class="highlight bash"><figcaption data-lang="bash"></figcaption><table><tr><td data-num="1"></td><td><pre>sh.addShard<span class="token punctuation">(</span><span class="token string">'localhost:10001'</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="2"></td><td><pre>sh.addShard<span class="token punctuation">(</span><span class="token string">'localhost:10002'</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="3"></td><td><pre>sh.addShard<span class="token punctuation">(</span><span class="token string">'localhost:10003'</span><span class="token punctuation">)</span></pre></td></tr></table></figure><p>查看集群的状态：分片摘要信息、数据库摘要信息、集合摘要信息等: <code>sh.status()</code></p><p><strong>分片验证:</strong></p><figure class="highlight bash"><figcaption data-lang="bash"></figcaption><table><tr><td data-num="1"></td><td><pre>连接 route 节点：mongo localhost:10005；</pre></td></tr><tr><td data-num="2"></td><td><pre></pre></td></tr><tr><td data-num="3"></td><td><pre>数据量太小可能导致分片失败，这是因为 chunksize 默认的大小是 64MB（ chunkSize 来制定块的大小，单位是 MB ），使用以下代码把 chunksize 改为 1MB 后，插入数据，便可以分片成功。</pre></td></tr><tr><td data-num="4"></td><td><pre></pre></td></tr><tr><td data-num="5"></td><td><pre>use config</pre></td></tr><tr><td data-num="6"></td><td><pre>db.settings.save<span class="token punctuation">(</span> <span class="token punctuation">&#123;</span> _id:<span class="token string">"chunksize"</span>, value: <span class="token number">1</span> <span class="token punctuation">&#125;</span> <span class="token punctuation">)</span></pre></td></tr><tr><td data-num="7"></td><td><pre>对集合使用的数据库启用分片：</pre></td></tr><tr><td data-num="8"></td><td><pre>sh.enableSharding<span class="token punctuation">(</span><span class="token string">"test"</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="9"></td><td><pre>添加索引：</pre></td></tr><tr><td data-num="10"></td><td><pre>db.user.ensureIndex<span class="token punctuation">(</span><span class="token punctuation">&#123;</span> <span class="token string">"uid"</span> <span class="token builtin class-name">:</span> <span class="token number">1</span><span class="token punctuation">&#125;</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="11"></td><td><pre>分片：</pre></td></tr><tr><td data-num="12"></td><td><pre>sh.shardCollection<span class="token punctuation">(</span><span class="token string">"test.user"</span>,<span class="token punctuation">&#123;</span><span class="token string">"uid"</span> <span class="token builtin class-name">:</span> <span class="token number">1</span><span class="token punctuation">&#125;</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="13"></td><td><pre>插入10万条数据（大概需要40s 左右）：</pre></td></tr><tr><td data-num="14"></td><td><pre>use <span class="token builtin class-name">test</span></pre></td></tr><tr><td data-num="15"></td><td><pre>for<span class="token punctuation">(</span>i<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span>i<span class="token operator">&lt;</span><span class="token number">100000</span><span class="token punctuation">;</span>i++<span class="token punctuation">)</span><span class="token punctuation">&#123;</span>db.user.insert<span class="token punctuation">(</span><span class="token punctuation">&#123;</span>uid:i,username:<span class="token string">'test-'</span>+i<span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="16"></td><td><pre>去各个节点查看数据分布情况：查询的文档条数，加起来正好10万条。</pre></td></tr></table></figure></li></ul><p><span class="exturl" data-url="aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L2N1bmNoaTQyMjEvYXJ0aWNsZS9kZXRhaWxzLzEwNzQ3MzU0NA==">findAndModify()</span></p><p><span class="exturl" data-url="aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3UwMTMzMTAwNzUvYXJ0aWNsZS9kZXRhaWxzLzI1NjU3NzY5">runCommand()</span></p></div><footer><div class="meta"><span class="item"><span class="icon"><i class="ic i-calendar-check"></i> </span><span class="text">更新于</span> <time title="修改时间：2023-10-24 14:35:58" itemprop="dateModified" datetime="2023-10-24T14:35:58+08:00">2023-10-24</time> </span><span id="computer-science/mongo/mongodb/" class="item leancloud_visitors" data-flag-title="MongoDB" title="阅读次数"><span class="icon"><i class="ic i-eye"></i> </span><span class="text">阅读次数</span> <span class="leancloud-visitors-count"></span> <span class="text">次</span></span></div><div class="reward"><button><i class="ic i-heartbeat"></i> 赞赏</button><p>请我喝[茶]~(￣▽￣)~*</p><div id="qr"><div><img data-src="/images/wechatpay.png" alt="obsidianlyg 微信支付"><p>微信支付</p></div></div></div><div id="copyright"><ul><li class="author"><strong>本文作者： </strong>obsidianlyg <i class="ic i-at"><em>@</em></i></li><li class="link"><strong>本文链接：</strong> <a href="https://obsidianlyg.github.io/computer-science/mongo/mongodb/" title="MongoDB">https://obsidianlyg.github.io/computer-science/mongo/mongodb/</a></li><li class="license"><strong>版权声明： </strong>本站所有文章除特别声明外，均采用 <span class="exturl" data-url="aHR0cHM6Ly9jcmVhdGl2ZWNvbW1vbnMub3JnL2xpY2Vuc2VzL2J5LW5jLXNhLzQuMC9kZWVkLnpo"><i class="ic i-creative-commons"><em>(CC)</em></i>BY-NC-SA</span> 许可协议。转载请注明出处！</li></ul></div></footer></article></div><div class="post-nav"><div class="item left"><a href="/computer-science/note/theme-shoka-doc/special/" itemprop="url" rel="prev" data-background-image="https:&#x2F;&#x2F;t3.picb.cc&#x2F;2023&#x2F;06&#x2F;15&#x2F;IXzXFN.png" title="Step.4 主题特殊功能"><span class="type">上一篇</span> <span class="category"><i class="ic i-flag"></i> Theme Shoka Documentation</span><h3>Step.4 主题特殊功能</h3></a></div><div class="item right"><a href="/Windows%E5%BF%AB%E6%8D%B7%E9%94%AE%E4%BD%BF%E7%94%A8/" itemprop="url" rel="next" data-background-image="https:&#x2F;&#x2F;t3.picb.cc&#x2F;2023&#x2F;06&#x2F;15&#x2F;IXDO3T.jpg" title="Windows快捷键使用"><span class="type">下一篇</span> <span class="category"><i class="ic i-flag"></i></span><h3>Windows快捷键使用</h3></a></div></div><div class="wrap" id="comments"></div></div><div id="sidebar"><div class="inner"><div class="panels"><div class="inner"><div class="contents panel pjax" data-title="文章目录"><ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#mongodb"><span class="toc-number">1.</span> <span class="toc-text">MongoDB</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%B0%86mongodb%E5%8A%A0%E5%85%A5%E5%88%B0windows%E6%9C%8D%E5%8A%A1%E4%B8%AD"><span class="toc-number">1.1.</span> <span class="toc-text">将 MongoDB 加入到 Windows 服务中</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%AF%BC%E5%87%BA%E9%9B%86%E5%90%88"><span class="toc-number">1.2.</span> <span class="toc-text">导出集合</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%AF%BC%E5%85%A5%E6%96%87%E4%BB%B6"><span class="toc-number">1.3.</span> <span class="toc-text">导入文件</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%95%B0%E6%8D%AE%E5%BA%93%E6%93%8D%E4%BD%9C"><span class="toc-number">1.4.</span> <span class="toc-text">数据库操作</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E9%9B%86%E5%90%88%E6%93%8D%E4%BD%9C"><span class="toc-number">1.5.</span> <span class="toc-text">集合操作</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%9F%BA%E6%9C%AC%E7%9F%A5%E8%AF%86%E7%82%B9%E5%AD%A6%E4%B9%A0%E9%80%9A%E6%B5%8B%E8%AF%95%E9%A2%98"><span class="toc-number">1.6.</span> <span class="toc-text">基本知识点（学习通测试题）</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#find%E7%B3%BB%E5%88%97"><span class="toc-number">1.7.</span> <span class="toc-text">find 系列</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#update%E7%B3%BB%E5%88%97"><span class="toc-number">1.8.</span> <span class="toc-text">update 系列</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#aggregate%E7%B3%BB%E5%88%97"><span class="toc-number">1.9.</span> <span class="toc-text">aggregate 系列</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#mapreduce"><span class="toc-number">1.10.</span> <span class="toc-text">MapReduce</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#createindex%E7%B4%A2%E5%BC%95"><span class="toc-number">1.11.</span> <span class="toc-text">createIndex () 索引</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%88%9B%E5%BB%BA%E4%BB%93%E5%BA%93%E7%AE%A1%E7%90%86%E5%91%98"><span class="toc-number">1.12.</span> <span class="toc-text">创建仓库管理员</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%B8%BB%E4%BB%8E%E5%A4%8D%E5%88%B6"><span class="toc-number">1.13.</span> <span class="toc-text">主从复制</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%89%AF%E6%9C%AC%E9%9B%86%E7%9A%84%E6%90%AD%E5%BB%BAlinux"><span class="toc-number">1.14.</span> <span class="toc-text">副本集的搭建（Linux）</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%89%AF%E6%9C%AC%E9%9B%86%E7%9A%84%E6%90%AD%E5%BB%BAwindows"><span class="toc-number">1.15.</span> <span class="toc-text">副本集的搭建（Windows）</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%A4%B4%E6%AD%8C%E4%B8%8A%E7%9A%84%E5%89%AF%E6%9C%AC%E6%90%AD%E5%BB%BA"><span class="toc-number">1.16.</span> <span class="toc-text">头歌上的副本搭建</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%A4%B4%E6%AD%8C%E7%9A%84%E5%88%86%E7%89%87%E9%9B%86%E6%90%AD%E5%BB%BA"><span class="toc-number">1.17.</span> <span class="toc-text">头歌的分片集搭建</span></a></li></ol></li></ol></div><div class="related panel pjax" data-title="系列文章"><ul><li class="active"><a href="/computer-science/mongo/mongodb/" rel="bookmark" title="MongoDB">MongoDB</a></li></ul></div><div class="overview panel" data-title="站点概览"><div class="author" itemprop="author" itemscope itemtype="http://schema.org/Person"><img class="image" itemprop="image" alt="obsidianlyg" data-src="/images/avatar.jpg"><p class="name" itemprop="name">obsidianlyg</p><div class="description" itemprop="description">最好的生活是：时光，浓淡相宜，人心，远近相安</div></div><nav class="state"><div class="item posts"><a href="/archives/"><span class="count">48</span> <span class="name">文章</span></a></div><div class="item categories"><a href="/categories/"><span class="count">8</span> <span class="name">分类</span></a></div><div class="item tags"><a href="/tags/"><span class="count">17</span> <span class="name">标签</span></a></div></nav><div class="social"><span class="exturl item github" data-url="aHR0cHM6Ly9naXRodWIuY29tL29ic2lkaWFubHln" title="https:&#x2F;&#x2F;github.com&#x2F;obsidianlyg"><i class="ic i-github"></i></span> <span class="exturl item zhihu" data-url="aHR0cHM6Ly93d3cuemhpaHUuY29tL3Blb3BsZS9jYW4tbmlhbi0zMQ==" title="https:&#x2F;&#x2F;www.zhihu.com&#x2F;people&#x2F;can-nian-31"><i class="ic i-zhihu"></i></span> <span class="exturl item music" data-url="aHR0cHM6Ly9tdXNpYy4xNjMuY29tLyMvdXNlci9ob21lP2lkPTYwNDc3MDA3NQ==" title="https:&#x2F;&#x2F;music.163.com&#x2F;#&#x2F;user&#x2F;home?id&#x3D;604770075"><i class="ic i-cloud-music"></i></span> <span class="exturl item about" data-url="aHR0cHM6Ly9vYnNpZGlhbmx5Zy5naXRlZS5pby9hYm91dA==" title="https:&#x2F;&#x2F;obsidianlyg.gitee.io&#x2F;about"><i class="ic i-address-card"></i></span> <span class="exturl item email" data-url="bWFpbHRvOjg3OTE0Mjk2NEBxcS5jb20=" title="mailto:879142964@qq.com"><i class="ic i-envelope"></i></span></div><ul class="menu"><li class="item"><a href="/" rel="section"><i class="ic i-home"></i>首页</a></li><li class="item dropdown"><a href="javascript:void(0);"><i class="ic i-feather"></i>文章</a><ul class="submenu"><li class="item"><a href="/archives/" rel="section"><i class="ic i-list-alt"></i>归档</a></li><li class="item"><a href="/categories/" rel="section"><i class="ic i-th"></i>分类</a></li><li class="item"><a href="/tags/" rel="section"><i class="ic i-tags"></i>标签</a></li></ul></li><li class="item"><a href="/friends/" rel="section"><i class="ic i-magic"></i>友链</a></li><li class="item"><a href="/about/" rel="section"><i class="ic i-user"></i>关于</a></li></ul></div></div></div><ul id="quick"><li class="prev pjax"><a href="/computer-science/note/theme-shoka-doc/special/" rel="prev" title="上一篇"><i class="ic i-chevron-left"></i></a></li><li class="up"><i class="ic i-arrow-up"></i></li><li class="down"><i class="ic i-arrow-down"></i></li><li class="next pjax"><a href="/Windows%E5%BF%AB%E6%8D%B7%E9%94%AE%E4%BD%BF%E7%94%A8/" rel="next" title="下一篇"><i class="ic i-chevron-right"></i></a></li><li class="percent"></li></ul></div></div><div class="dimmer"></div></div></main><footer id="footer"><div class="inner"><div class="widgets"><div class="rpost pjax"><h2>随机文章</h2><ul><li class="item"><div class="breadcrumb"><a href="/categories/usetest/" title="分类于 使用测试">使用测试</a> <i class="ic i-angle-right"></i> <a href="/categories/usetest/mktest/" title="分类于 markdown 测试">markdown 测试</a></div><span><a href="/usetest/mktest/markdown/" title="Markdown Style test">Markdown Style test</a></span></li><li class="item"><div class="breadcrumb"><a href="/categories/usetest/" title="分类于 使用测试">使用测试</a> <i class="ic i-angle-right"></i> <a href="/categories/usetest/mktest/" title="分类于 markdown 测试">markdown 测试</a></div><span><a href="/usetest/mktest/hello-world/" title="Hello World">Hello World</a></span></li><li class="item"><div class="breadcrumb"></div><span><a href="/Note/%E5%B0%9D%E8%AF%95%E5%90%84%E7%A7%8D%E5%8F%AF%E4%BB%A5%E8%81%94%E7%BD%91%E7%9A%84AI/" title="尝试各种可以联网的AI">尝试各种可以联网的AI</a></span></li><li class="item"><div class="breadcrumb"><a href="/categories/arch%E4%B8%AA%E4%BA%BA%E7%AC%94%E8%AE%B0/" title="分类于 arch 个人笔记">arch 个人笔记</a></div><span><a href="/Arch/Arch/arch%E6%8D%A2%E6%BA%90/" title="arch换源">arch换源</a></span></li><li class="item"><div class="breadcrumb"><a href="/categories/arch%E4%B8%AA%E4%BA%BA%E7%AC%94%E8%AE%B0/" title="分类于 arch 个人笔记">arch 个人笔记</a></div><span><a href="/Arch/Arch/WallPaper/" title="壁纸网站">壁纸网站</a></span></li><li class="item"><div class="breadcrumb"></div><span><a href="/Note/%E7%A7%BB%E5%8A%A8%E5%BA%94%E7%94%A8%E6%B5%8B%E8%AF%95/" title="移动应用测试">移动应用测试</a></span></li><li class="item"><div class="breadcrumb"></div><span><a href="/Note/redis%E5%85%A5%E9%97%A8/" title="redis入门">redis入门</a></span></li><li class="item"><div class="breadcrumb"><a href="/categories/arch%E4%B8%AA%E4%BA%BA%E7%AC%94%E8%AE%B0/" title="分类于 arch 个人笔记">arch 个人笔记</a></div><span><a href="/Arch/Arch/ranger%E5%B8%B8%E7%94%A8%E5%91%BD%E4%BB%A4/" title="ranger常用命令">ranger常用命令</a></span></li><li class="item"><div class="breadcrumb"></div><span><a href="/Note/%E5%85%B3%E4%BA%8EUniApp%E4%BD%BF%E7%94%A8%E7%9A%84%E4%B8%AA%E4%BA%BA%E7%AC%94%E8%AE%B0/" title="关于UniApp使用的个人笔记">关于UniApp使用的个人笔记</a></span></li><li class="item"><div class="breadcrumb"><a href="/categories/arch%E4%B8%AA%E4%BA%BA%E7%AC%94%E8%AE%B0/" title="分类于 arch 个人笔记">arch 个人笔记</a></div><span><a href="/Arch/Arch/snap%E7%9A%84%E5%AE%89%E8%A3%85%E4%B8%8E%E4%BD%BF%E7%94%A8/" title="snap的安装与使用">snap的安装与使用</a></span></li></ul></div><div><h2>最新评论</h2><ul class="leancloud-recent-comment"></ul></div></div><div class="status"><div class="copyright">&copy; 2021 – <span itemprop="copyrightYear">2024</span> <span class="with-love"><i class="ic i-sakura rotate"></i> </span><span class="author" itemprop="copyrightHolder">obsidianlyg @ Obsidianlyg's Blog</span></div><div class="count"><span class="post-meta-item-icon"><i class="ic i-chart-area"></i> </span><span title="站点总字数">155k 字</span> <span class="post-meta-divider">|</span> <span class="post-meta-item-icon"><i class="ic i-coffee"></i> </span><span title="站点阅读时长">2:21</span></div><div class="powered-by">基于 <span class="exturl" data-url="aHR0cHM6Ly9oZXhvLmlv">Hexo</span> & Theme.<span class="exturl" data-url="aHR0cHM6Ly9naXRodWIuY29tL2FtZWhpbWUvaGV4by10aGVtZS1zaG9rYQ==">Shoka</span><br></div></div></div></footer></div><script data-config type="text/javascript">var LOCAL={path:"computer-science/mongo/mongodb/",favicon:{show:"（●´3｀●）怎么才来",hide:"(´Д｀)人没了！"},search:{placeholder:"文章搜索",empty:"关于 「 ${query} 」，什么也没搜到",stats:"${time} ms 内找到 ${hits} 条结果"},valine:!0,copy_tex:!0,katex:!0,mermaid:!0,fancybox:!0,copyright:'复制成功，转载请遵守 <i class="ic i-creative-commons"></i>BY-NC-SA 协议。',quiz:{choice:"单选题",multiple:"多选题",true_false:"判断题",essay:"问答题",gap_fill:"填空题",mistake:"错题备注"},ignores:[function(e){return e.includes("#")},function(e){return new RegExp(LOCAL.path+"$").test(e)}]}</script><script src="https://cdn.polyfill.io/v2/polyfill.js"></script><script src="//cdn.jsdelivr.net/combine/npm/pace-js@1.0.2/pace.min.js,npm/pjax@0.2.8/pjax.min.js,npm/whatwg-fetch@3.4.0/dist/fetch.umd.min.js,npm/animejs@3.2.0/lib/anime.min.js,npm/algoliasearch@4/dist/algoliasearch-lite.umd.js,npm/instantsearch.js@4/dist/instantsearch.production.min.js,npm/lozad@1/dist/lozad.min.js,npm/quicklink@2/dist/quicklink.umd.js"></script><script src="/js/app.js?v=0.2.5"></script></body></html>